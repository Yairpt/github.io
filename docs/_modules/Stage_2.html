

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Stage_2 &mdash; Wave_Function_Propagation 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Wave_Function_Propagation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">WaveFunctionPropagation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Wave_Function_Propagation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>Stage_2</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for Stage_2</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">Locpot_class</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">Help_function_library_yair</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy.fft</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span> <span class="n">ifft</span><span class="p">,</span> <span class="n">fftfreq</span><span class="p">,</span> <span class="n">fft2</span><span class="p">,</span> <span class="n">ifft2</span><span class="p">,</span> <span class="n">fftshift</span><span class="p">,</span> <span class="n">ifftshift</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">PillowWriter</span>



<div class="viewcode-block" id="Stage_2"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2">[docs]</a><span class="k">class</span> <span class="nc">Stage_2</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class aimed to locate the initial wavefunction we created at stage_1,</span>
<span class="sd">    on the relevant material from stage_1, in the middle of the material in the interface system.</span>

<span class="sd">    &#39;&#39;&#39;</span>


<div class="viewcode-block" id="Stage_2.__init__"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Locp</span><span class="p">,</span> <span class="n">grid_density</span><span class="p">,</span> <span class="n">psi0_dic</span><span class="p">,</span> <span class="n">allmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">To_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">Nt</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="p">,</span><span class="n">multi_left</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">multi_right</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">is2d</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Has_interface</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">limits_for_itself</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ref_point</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;**Initilization**:</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Locp : Locpot_yair.object</span>
<span class="sd">                Locpot object that holds the information about the interface system.</span>
<span class="sd">        grid_density : float</span>
<span class="sd">                grid density factor calculated in stage_1</span>
<span class="sd">        psi0_dic : dict</span>
<span class="sd">                psi0 parameters given in a dictionary form. Necessary to reconstruct the initial wave function in the</span>
<span class="sd">                interface system.</span>
<span class="sd">        allmin : np.array, array_like, optional, default: None</span>
<span class="sd">                Not necessary for the intialization. Holds all the minimum peaks of the local potential.</span>
<span class="sd">        allmax : np.array, array_like, optional, default: None</span>
<span class="sd">                Not necessary for the intialization. Holds all the maximum peaks of the local potential.</span>
<span class="sd">        To_plot : bool, optional, default: False</span>
<span class="sd">                A flag to determine whether to plot when this option is availale.</span>
<span class="sd">        Nt : int</span>
<span class="sd">                The number of time steps we would like to have in the propagation proccess.</span>
<span class="sd">        dt : float</span>
<span class="sd">                The size of the time step in ``sec``.</span>
<span class="sd">        multi_left : int, optional, default: 2</span>
<span class="sd">                How many times we wish add a unit cell length to the left side of the interface.</span>
<span class="sd">                Namely, for ``multi_left = 2``, we are adding ``2*a_left`` to the locpot vector.</span>
<span class="sd">        multi_right : int, optional, default: 2</span>
<span class="sd">                How many times we wish add a unit cell length to the right side of the interface.</span>
<span class="sd">                Namely, for ``multi_right = 2``, we are adding ``2*a_right`` to the locpot vector.</span>
<span class="sd">        Has_interface : bool, optional, default: True</span>
<span class="sd">                A flag indicates whether the system conatains an interface or not.</span>
<span class="sd">                For a surface, it is recomended to relate the vaccum as the interface.</span>
<span class="sd">        limits_for_itself : list [float, float], optional, default: None</span>
<span class="sd">                This parameter is an optional for flexibility for chosing the range of where the pick the bulk-like potential.</span>
<span class="sd">                This should be input as a list of two floats, the first one is for the left limit and the second one is for the left limit.</span>
<span class="sd">                Should be given as the same units of the spatial coordainates vector, ``z``.</span>
<span class="sd">        ref_point : float, optional, default: None</span>
<span class="sd">                If the current system does not have an interface, and we want to treat it as it as a reference point for later calculations.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span> <span class="o">=</span> <span class="n">Has_interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locp</span> <span class="o">=</span> <span class="n">Locp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">set_locpot_bulk_materials</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is2d</span> <span class="o">=</span> <span class="n">is2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">locpot_vec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">locpot_vec</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># determined by the</span>
        <span class="c1"># last position in the locpot of the whole system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">=</span> <span class="n">Nt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allmin</span> <span class="o">=</span> <span class="n">allmin</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allmin</span> <span class="o">=</span> <span class="n">find_peaks_minima</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">locpot_vec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allmax</span> <span class="o">=</span> <span class="n">allmax</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allmax</span> <span class="o">=</span> <span class="n">find_peaks_maxima</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">locpot_vec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons</span> <span class="o">=</span> <span class="n">Constants</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">To_plot</span> <span class="o">=</span> <span class="n">To_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span> <span class="o">=</span> <span class="n">psi0_dic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span> <span class="o">=</span> <span class="n">grid_density</span> <span class="c1"># [samples/A]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_left</span> <span class="o">=</span> <span class="n">multi_left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_right</span> <span class="o">=</span> <span class="n">multi_right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_original_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">find_interface</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_converged_spatial_grid</span><span class="p">(</span><span class="n">update_converged_vec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">update_interface</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limits_for_itself</span><span class="o">=</span><span class="n">limits_for_itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">=</span> <span class="n">ref_point</span></div>



<div class="viewcode-block" id="Stage_2.elongate_interface_potential"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.elongate_interface_potential">[docs]</a>    <span class="k">def</span> <span class="nf">elongate_interface_potential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_iteslf</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">side_from_itself</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">interface_position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">manual</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">z_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">v_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">multi_manual</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                      <span class="n">pos_to_insert</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">locpot_vector</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">To_update</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">original_interface</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        from_iteslf : bool, optional, default: False</span>
<span class="sd">                This flag indicates whether to take the bulk-like potential that is going to be</span>
<span class="sd">                multiplied and then inserted - from itself - namely - from the middle of the local potnetial - far from the</span>
<span class="sd">                interface positions (since it satisfies periodic condition). Otherwise - it is taken from outer-scope file -</span>
<span class="sd">                supplied in the same directory and is referred to the bulk-material locpot file - obtained from VASP.</span>
<span class="sd">        side_from_itself : {&#39;both&#39;, &#39;right&#39;, &#39;left&#39;}, optional, default: &#39;both&#39;</span>
<span class="sd">                Choices in brackets. This flag is being active only when the flag ``from_iteslf=True``.</span>
<span class="sd">        from_iteslf : bool, optional, default: True</span>
<span class="sd">                It indicates where we wish to elngate our local potential vector. -&gt; From both side, or only from only one side</span>
<span class="sd">                of the interface.</span>
<span class="sd">        interface_position : np.float, optional, default: None</span>
<span class="sd">                Enables to input the interface position manually. It refers to the spaciol coordinates.</span>
<span class="sd">                If your system does not have an interface, you should supply this argument with &#39;&#39;0&#39;&#39;.</span>
<span class="sd">        manual : bool, optional, default: False</span>
<span class="sd">                Enables the user to elongate its locpot vector&#39;s system manually.</span>
<span class="sd">                If this flag is turned on by supplying ``manual = True``, the user must also supply ``z_in`` and ``v_in`` vectors.</span>
<span class="sd">        z_in : np.array, array_like, optional, default: None</span>
<span class="sd">                When the user decides on elongating manually its locpot vector&#39;s system,</span>
<span class="sd">                he should supplied also ``z_in`` and ``v_in`` as the spatial grid\coordinates vector and the local potential vector</span>
<span class="sd">                respectively.</span>
<span class="sd">        v_in : np.array, array_like, optional, default: None</span>
<span class="sd">                When the user decides on elongating manually its locpot vector&#39;s system,</span>
<span class="sd">                he should supplied also ``z_in`` and ``v_in`` as the spatial grid\coordinates vector and the local potential vector</span>
<span class="sd">                respectively.</span>
<span class="sd">        multi_manual : int, optional, default: 1</span>
<span class="sd">                When the user decides on elongating manually its locpot vector&#39;s system,</span>
<span class="sd">                it enables him to determine how many times to multiply the inserted locpot vector. This flag is also used</span>
<span class="sd">                in the case when to option of ``from_itself`` is turned on.</span>
<span class="sd">        pos_to_insert : float, optional, default: None</span>
<span class="sd">                When this argument is supplied, is enables determine the position where</span>
<span class="sd">                to insert the locpot vector during the elongation proccess.</span>
<span class="sd">        locpot_vector : `numpy.ndarray`, (N, 2), optional, default: None</span>
<span class="sd">                The first column is the spatial grid/coordinates vector, and the second vector is local potential.</span>
<span class="sd">                It enables to elongate a locpot vector that is not related</span>
<span class="sd">                to the class instance attributes.</span>
<span class="sd">        To_update : bool, optional, default: True</span>
<span class="sd">                A flag indicates if the changes that have being made are going to be updated as the instance attributes.</span>
<span class="sd">        original_interface : float, optional, default: None</span>
<span class="sd">                If specified, all the extention procedure will be considering this interface position during all the procedure.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Elongated locpot_vec : numpy.ndarray, (N, 2)</span>
<span class="sd">                It consists of 2 columns. First column is the spatial coordinates, the second column is the local potential values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is2d</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">from_iteslf</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">manual</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                        <span class="n">elongated_locpot_vec</span><span class="p">,</span><span class="n">delta_left</span><span class="p">,</span><span class="n">delta_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">elongate_locpot</span><span class="p">(</span><span class="n">multi_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_left</span><span class="p">,</span> <span class="n">multi_right</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_right</span><span class="p">,</span><span class="n">return_left_increment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_right_increment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pos_to_insert</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">elongated_locpot_vec</span><span class="p">,</span><span class="n">delta_left</span><span class="p">,</span><span class="n">temp_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">elongate_locpot</span><span class="p">(</span> <span class="n">manual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos_to_insert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">z_to_insert_manual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">v_to_insert_manual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">return_left_increment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">elongated_locpot_vec</span><span class="p">,</span><span class="n">delta_left</span><span class="p">,</span><span class="n">temp_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">elongate_locpot</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos_to_insert</span><span class="o">=</span>
                            <span class="n">pos_to_insert</span><span class="p">,</span> <span class="n">z_to_insert_manual</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                                                             <span class="n">v_to_insert_manual</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span><span class="n">return_left_increment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">To_update</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="n">elongated_locpot_vec</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_converged_spatial_grid</span><span class="p">(</span><span class="n">vecor_to_update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">,</span><span class="n">update_converged_vec</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">update_interface</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">index_interface</span><span class="p">,</span> <span class="n">interface_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">index_interface</span><span class="p">,</span> <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">interface_pos</span> <span class="o">+</span> <span class="n">delta_left</span>
                            <span class="c1"># index_interface, interface_pos = self.locp.find_interface(x=self.elongated_locpot_vec[:, 0],</span>
                            <span class="c1">#                                                       y=self.elongated_locpot_vec[:, 1])</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">&lt;=</span> <span class="n">interface_pos</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">index_original_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">,</span>
                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">index_original_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">&gt;=</span> <span class="n">pos_to_insert</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">+=</span> <span class="n">delta_left</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span>
                        <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_converged_spatial_grid</span><span class="p">(</span>
                            <span class="n">vecor_to_update</span><span class="o">=</span><span class="n">elongated_locpot_vec</span><span class="p">,</span> <span class="n">update_converged_vec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">update_interface</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">elongated_locpot_vec</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">## manual, but not from itself.</span>
                    <span class="k">if</span> <span class="n">z_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You chose manual elongation. However you did not supplied coordinates and local potential vectors.&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pos_to_insert</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">pos_to_insert</span> <span class="o">=</span> <span class="n">z_in</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">locpot_vector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">elongated_locpot_vec</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">ref_pos</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">elongate_locpot</span><span class="p">(</span><span class="n">manual</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pos_to_insert</span> <span class="o">=</span> <span class="n">pos_to_insert</span><span class="p">,</span>
                                    <span class="n">multi_manual</span><span class="o">=</span> <span class="n">multi_manual</span><span class="p">,</span> <span class="n">z_to_insert_manual</span> <span class="o">=</span> <span class="n">z_in</span><span class="p">,</span> <span class="n">v_to_insert_manual</span> <span class="o">=</span> <span class="n">v_in</span><span class="p">,</span><span class="n">locpot_vec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">,</span><span class="n">return_left_increment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">elongated_locpot_vec</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">ref_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">elongate_locpot</span><span class="p">(</span><span class="n">manual</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pos_to_insert</span> <span class="o">=</span> <span class="n">pos_to_insert</span><span class="p">,</span>
                                    <span class="n">multi_manual</span><span class="o">=</span> <span class="n">multi_manual</span><span class="p">,</span> <span class="n">z_to_insert_manual</span> <span class="o">=</span> <span class="n">z_in</span><span class="p">,</span> <span class="n">v_to_insert_manual</span> <span class="o">=</span> <span class="n">v_in</span><span class="p">,</span><span class="n">return_left_increment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">elongated_locpot_vec</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">ref_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">elongate_locpot</span><span class="p">(</span><span class="n">manual</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pos_to_insert</span> <span class="o">=</span> <span class="n">pos_to_insert</span><span class="p">,</span>
                                <span class="n">multi_manual</span><span class="o">=</span> <span class="n">multi_manual</span><span class="p">,</span> <span class="n">z_to_insert_manual</span> <span class="o">=</span> <span class="n">z_in</span><span class="p">,</span> <span class="n">v_to_insert_manual</span> <span class="o">=</span> <span class="n">v_in</span><span class="p">,</span><span class="n">locpot_vec</span><span class="o">=</span><span class="n">locpot_vector</span><span class="p">,</span><span class="n">return_left_increment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">To_update</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="n">elongated_locpot_vec</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="n">to_2_column_mat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_converged_spatial_grid</span><span class="p">(</span>
                                <span class="n">vecor_to_update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">,</span> <span class="n">update_converged_vec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">update_interface</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">original_interface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">index_interface</span><span class="p">,</span> <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span>
                                        <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">original_interface</span><span class="p">),</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
                                <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">index_interface</span><span class="p">,</span> <span class="n">interface_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">index_interface</span><span class="p">,</span> <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">ref_pos</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">):</span>
                                    <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
                                <span class="c1"># index_interface, interface_pos = self.locp.find_interface(x=self.elongated_locpot_vec[:, 0],</span>
                                <span class="c1">#                                                       y=self.elongated_locpot_vec[:, 1])</span>
                                <span class="k">if</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">index_original_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">),</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_original_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">),</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">&gt;=</span> <span class="n">pos_to_insert</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">+=</span> <span class="n">delta</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_converged_spatial_grid</span><span class="p">(</span>
                                <span class="n">vecor_to_update</span><span class="o">=</span><span class="n">elongated_locpot_vec</span><span class="p">,</span> <span class="n">update_converged_vec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">update_interface</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">elongated_locpot_vec</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1">## from itself. Namely - searching for bulk-like potential form, and then inserting it for enlongating the locpot.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">locpot_vector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">locpot_vector</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">locpot_vector</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">interface_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ind_interface</span><span class="p">,</span> <span class="n">interface_position</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">find_interface</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ind_interface</span><span class="p">,</span> <span class="n">interface_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span>

                <span class="n">z</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="n">original_z_length</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                    <span class="n">interface_position</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">interface_position</span><span class="p">)</span>
                <span class="c1">## both sides elongation</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">side_from_itself</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits_for_itself</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">z_right</span><span class="p">,</span><span class="n">v_right</span><span class="p">,</span><span class="n">start_position_right</span> <span class="o">=</span> <span class="n">find_bulk_like_potential</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">interface_position</span><span class="p">,</span><span class="n">num_of_peaks</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                <span class="n">right</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">limits_for_itself</span><span class="p">)</span>
                            <span class="n">z_left</span><span class="p">,</span><span class="n">v_left</span><span class="p">,</span><span class="n">start_position_left</span> <span class="o">=</span> <span class="n">find_bulk_like_potential</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">interface_position</span><span class="p">,</span> <span class="n">num_of_peaks</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                <span class="n">left</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">limits_for_itself</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">z_right</span><span class="p">,</span><span class="n">v_right</span><span class="p">,</span><span class="n">start_position_right</span> <span class="o">=</span> <span class="n">find_bulk_like_potential</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">interface_position</span><span class="p">,</span><span class="n">num_of_peaks</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                <span class="n">right</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                            <span class="n">z_left</span><span class="p">,</span><span class="n">v_left</span><span class="p">,</span><span class="n">start_position_left</span> <span class="o">=</span> <span class="n">find_bulk_like_potential</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">interface_position</span><span class="p">,</span> <span class="n">num_of_peaks</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                <span class="n">left</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">z_right</span><span class="p">,</span> <span class="n">v_right</span> <span class="o">=</span> <span class="n">adjust_grid_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span><span class="p">,</span><span class="n">z_right</span><span class="p">,</span> <span class="n">v_right</span><span class="p">)</span>
                        <span class="n">z_right</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">z_right</span><span class="p">)</span>
                        <span class="n">z_left</span><span class="p">,</span> <span class="n">v_left</span> <span class="o">=</span> <span class="n">adjust_grid_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span><span class="p">,</span> <span class="n">z_left</span><span class="p">,</span> <span class="n">v_left</span><span class="p">)</span>
                        <span class="n">z_left</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">z_left</span><span class="p">)</span>
                        <span class="n">init_len</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">elongate_locpot</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos_to_insert</span><span class="o">=</span><span class="n">start_position_left</span><span class="p">,</span>
                            <span class="n">multi_manual</span><span class="o">=</span><span class="n">multi_manual</span><span class="p">,</span><span class="n">locpot_vec</span><span class="o">=</span><span class="n">to_2_column_mat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">)</span> <span class="p">,</span><span class="n">z_to_insert_manual</span><span class="o">=</span><span class="n">z_left</span><span class="p">,</span><span class="n">v_to_insert_manual</span><span class="o">=</span><span class="n">v_left</span><span class="p">)</span>
                        <span class="n">differ</span> <span class="o">=</span> <span class="n">to_2_column_mat</span><span class="p">(</span><span class="n">elongated_locpot_vec</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">init_len</span>
                        <span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">elongate_locpot</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos_to_insert</span><span class="o">=</span><span class="n">start_position_right</span><span class="o">+</span><span class="n">differ</span><span class="p">,</span>
                            <span class="n">multi_manual</span><span class="o">=</span><span class="n">multi_manual</span><span class="p">,</span> <span class="n">z_to_insert_manual</span><span class="o">=</span><span class="n">z_right</span><span class="o">+</span><span class="n">differ</span><span class="p">,</span><span class="n">v_to_insert_manual</span><span class="o">=</span><span class="n">v_right</span><span class="p">,</span>
                            <span class="n">locpot_vec</span><span class="o">=</span><span class="n">to_2_column_mat</span><span class="p">(</span><span class="n">elongated_locpot_vec</span><span class="p">))</span>
                    <span class="c1">## only left side elongation</span>
                    <span class="k">elif</span> <span class="n">side_from_itself</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits_for_itself</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">z_left</span><span class="p">,</span> <span class="n">v_left</span><span class="p">,</span> <span class="n">start_position_left</span> <span class="o">=</span> <span class="n">find_bulk_like_potential</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">interface_position</span><span class="p">,</span><span class="n">num_of_peaks</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                                                           <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">limits_for_itself</span><span class="p">)</span>
                            <span class="n">z_left</span><span class="p">,</span> <span class="n">v_left</span> <span class="o">=</span> <span class="n">adjust_grid_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span><span class="p">,</span> <span class="n">z_left</span><span class="p">,</span> <span class="n">v_left</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">z_left</span><span class="p">,</span> <span class="n">v_left</span><span class="p">,</span> <span class="n">start_position_left</span> <span class="o">=</span> <span class="n">find_bulk_like_potential</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">interface_position</span><span class="p">,</span><span class="n">num_of_peaks</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                                                           <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">z_left</span><span class="p">,</span> <span class="n">v_left</span> <span class="o">=</span> <span class="n">adjust_grid_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span><span class="p">,</span> <span class="n">z_left</span><span class="p">,</span> <span class="n">v_left</span><span class="p">)</span>
                        <span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">elongate_locpot</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos_to_insert</span><span class="o">=</span><span class="n">start_position_left</span><span class="p">,</span>
                            <span class="n">multi_manual</span><span class="o">=</span><span class="n">multi_manual</span><span class="p">,</span><span class="n">z_to_insert_manual</span><span class="o">=</span><span class="n">z_left</span><span class="p">,</span> <span class="n">v_to_insert_manual</span><span class="o">=</span><span class="n">v_left</span><span class="p">,</span><span class="n">locpot_vec</span><span class="o">=</span><span class="n">to_2_column_mat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">))</span>
                    <span class="c1">## only right side elongation</span>
                    <span class="k">elif</span> <span class="n">side_from_itself</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits_for_itself</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">z_right</span><span class="p">,</span> <span class="n">v_right</span><span class="p">,</span> <span class="n">start_position_right</span> <span class="o">=</span> <span class="n">find_bulk_like_potential</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">interface_position</span><span class="p">,</span><span class="n">num_of_peaks</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                                                              <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">limits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">limits_for_itself</span><span class="p">)</span>
                            <span class="n">z_right</span><span class="p">,</span> <span class="n">v_right</span> <span class="o">=</span> <span class="n">adjust_grid_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span><span class="p">,</span> <span class="n">z_right</span><span class="p">,</span> <span class="n">v_right</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">z_right</span><span class="p">,</span> <span class="n">v_right</span><span class="p">,</span> <span class="n">start_position_right</span> <span class="o">=</span> <span class="n">find_bulk_like_potential</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">interface_position</span><span class="p">,</span><span class="n">num_of_peaks</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                                                                              <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">z_right</span><span class="p">,</span> <span class="n">v_right</span> <span class="o">=</span> <span class="n">adjust_grid_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span><span class="p">,</span> <span class="n">z_right</span><span class="p">,</span> <span class="n">v_right</span><span class="p">)</span>
                        <span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">elongate_locpot</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos_to_insert</span><span class="o">=</span><span class="n">start_position_right</span><span class="p">,</span>
                            <span class="n">multi_manual</span><span class="o">=</span><span class="n">multi_manual</span><span class="p">,</span><span class="n">z_to_insert_manual</span><span class="o">=</span><span class="n">z_right</span><span class="p">,</span><span class="n">v_to_insert_manual</span><span class="o">=</span><span class="n">v_right</span><span class="p">,</span><span class="n">locpot_vec</span><span class="o">=</span><span class="n">to_2_column_mat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Namely - does not have an interface, handling manually, elongating from itself:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits_for_itself</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># If limits for allocating the range of the calculation were not supplied:</span>
                        <span class="n">z</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">multiply_z_v_vecs</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span><span class="n">multi</span><span class="o">=</span><span class="n">multi_manual</span><span class="p">)</span>
                        <span class="n">z</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">adjust_grid_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                        <span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="n">to_2_column_mat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">z</span><span class="p">,</span><span class="n">v</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Performimg the elongation on a region within the system, defined by limits for allocating the desired range to look for bulk like locpot.</span>
                        <span class="n">z</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">start_position</span> <span class="o">=</span> <span class="n">find_bulk_like_potential</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">num_of_peaks</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                            <span class="n">limits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">limits_for_itself</span><span class="p">)</span>
                        <span class="n">z</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">adjust_grid_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                        <span class="n">z</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">elongated_locpot_vec</span><span class="p">,</span><span class="n">delta</span><span class="p">,</span><span class="n">temp_point</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">elongate_locpot</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos_to_insert</span><span class="o">=</span><span class="n">start_position</span><span class="p">,</span>
                            <span class="n">multi_manual</span><span class="o">=</span><span class="n">multi_manual</span><span class="p">,</span><span class="n">z_to_insert_manual</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">v_to_insert_manual</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">locpot_vec</span><span class="o">=</span><span class="n">to_2_column_mat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">),</span><span class="n">return_left_increment</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

                <span class="c1">## for all cases (from itself elongation) - updating elongated vector of the class instance.</span>
                <span class="k">if</span> <span class="n">To_update</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">index_interface</span><span class="p">,</span> <span class="n">interface_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">index_interface</span><span class="p">,</span> <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span><span class="p">,</span> <span class="n">elongated_locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">side_from_itself</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
                            <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">interface_pos</span> <span class="o">+</span> <span class="n">differ</span>
                        <span class="k">elif</span> <span class="n">side_from_itself</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
                            <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">elongated_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">elongated_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">original_z_length</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="n">to_2_column_mat</span><span class="p">(</span><span class="n">elongated_locpot_vec</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_converged_spatial_grid</span><span class="p">(</span>
                        <span class="n">vecor_to_update</span><span class="o">=</span><span class="n">to_2_column_mat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">),</span> <span class="n">update_converged_vec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update_interface</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                        <span class="c1">#interface_position = np.abs((self.elongated_locpot_vec[:,0][-1] - self.elongated_locpot_vec[:,0][0]) - original_z_length) + interface_position</span>
                        <span class="n">index_interface</span><span class="p">,</span> <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">,</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">interface_pos</span> <span class="o">&lt;=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">index_original_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">interface_pos</span> <span class="p">,</span>
                                     <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_original_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="o">=</span> <span class="n">index_interface</span><span class="p">,</span> <span class="n">interface_pos</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">&gt;=</span> <span class="n">pos_to_insert</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">+=</span> <span class="n">delta</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="n">to_2_column_mat</span><span class="p">(</span><span class="n">elongated_locpot_vec</span><span class="p">)</span>
                    <span class="n">elongated_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_converged_spatial_grid</span><span class="p">(</span>
                        <span class="n">vecor_to_update</span><span class="o">=</span><span class="n">to_2_column_mat</span><span class="p">(</span><span class="n">elongated_locpot_vec</span><span class="p">),</span> <span class="n">update_converged_vec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">update_interface</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">elongated_locpot_vec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;2D cases have not been programmed yet&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Stage_2.update_converged_spatial_grid"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.update_converged_spatial_grid">[docs]</a>    <span class="k">def</span> <span class="nf">update_converged_spatial_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vecor_to_update</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">update_converged_vec</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">update_interface</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        **Calculate spatial grid applying the converged grid density, for the interface system.**</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vecor_to_update : `numpy.ndarray`, (N, 2), optional, default: None</span>
<span class="sd">                This is a 2 column matrix. First colmn is ``z``, the spatial coordinates vector and second is ``v``, the local potential vector.</span>
<span class="sd">                If we wish apply this method on not related vector, not an object attribute.</span>
<span class="sd">        update_converged_vec : bool, optional, default: True</span>
<span class="sd">                A flag indicates whether to update the instance attribute with the new converged</span>
<span class="sd">                vector we obatin through this method.</span>
<span class="sd">        update_interface : bool, optional, default: False</span>
<span class="sd">                A flag indicates whether to update the instance attribute of the new interface found with the</span>
<span class="sd">                new interface position as we get by applying this method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">vecor_to_update</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">locpot_vec</span> <span class="o">=</span> <span class="n">to_2_column_mat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">locpot_vec</span><span class="p">)</span>
            <span class="n">vec_to_be_conv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">locpot_vec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vec_to_be_conv</span> <span class="o">=</span> <span class="n">vecor_to_update</span>
            <span class="n">vec_to_be_conv</span> <span class="o">=</span> <span class="n">to_2_column_mat</span><span class="p">(</span><span class="n">vec_to_be_conv</span><span class="p">)</span>
        <span class="n">vec_to_be_conv</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">vec_to_be_conv</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">vec_to_be_conv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">L</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">L</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">L</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="n">z</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">interpolate_pchip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">vec_to_be_conv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_converged_vec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">z</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span> <span class="o">=</span> <span class="n">to_2_column_mat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_interface</span><span class="p">:</span>
                <span class="n">index_interface</span><span class="p">,</span> <span class="n">interface_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">find_interface</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">z</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">v</span> <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">&lt;=</span> <span class="n">interface_pos</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">index_original_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">to_2_column_mat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">z</span><span class="p">,</span><span class="n">v</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Stage_2.find_initial_position_to_center_psi0"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.find_initial_position_to_center_psi0">[docs]</a>    <span class="k">def</span> <span class="nf">find_initial_position_to_center_psi0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_side</span> <span class="o">=</span> <span class="s1">&#39;Left&#39;</span><span class="p">,</span> <span class="n">manual</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">manual_pos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        init_side : str, {&#39;Left&#39;, &#39;Right&#39;}, Optional, default: &#39;Left&#39;</span>
<span class="sd">                The Choices are in the brackets. Determines what side of the interface to look for the inialization position.</span>
<span class="sd">        manual : int or float, optional, default: None</span>
<span class="sd">                It can be int for index insertion or a float for position insertion.</span>
<span class="sd">                Instead for automatically look for initial position, you can supply it directly via this argument.</span>
<span class="sd">                Also it assume that it is given as a spatial position.</span>
<span class="sd">        manual_pos: int or float, optional, default: None</span>
<span class="sd">                If specified, this will be the actual position that corresponding the local potential vector - where the wave-function will be initialized at.</span>
<span class="sd">        index : bool, optional, default: False</span>
<span class="sd">                If it is ``True``, then the manual argument will be read as index instead of spatial position.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        z0_position, z0_index : float, int</span>
<span class="sd">                The position and the matching index in the interfce system locpot vector,</span>
<span class="sd">                where psi0 will be initialized at. By default it will be at the middle of the left-side material.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">locpot_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_most_relevant_z_coordinate_vec</span><span class="p">()</span>
        <span class="n">locpot_vec</span> <span class="o">=</span> <span class="n">to_2_column_mat</span><span class="p">(</span><span class="n">locpot_vec</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">interface_pos</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interface_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">manual</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">init_side</span> <span class="o">==</span> <span class="s1">&#39;Left&#39;</span><span class="p">:</span>
                    <span class="c1"># z_left =  [i for i in self.locp.locpot_vec[:, 0] if i &lt;= interface_pos]</span>
                    <span class="n">all_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allmin</span><span class="p">[:,</span> <span class="p">:][</span><span class="bp">self</span><span class="o">.</span><span class="n">allmin</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">interface_pos</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_min</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">)</span>
                        <span class="n">all_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allmin</span><span class="p">[:,</span> <span class="p">:][</span><span class="bp">self</span><span class="o">.</span><span class="n">allmin</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">interface_pos</span><span class="p">]</span>
                    <span class="n">mid_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_min</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_min</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">mid_min</span> <span class="o">=</span> <span class="n">all_min</span><span class="p">[</span><span class="n">mid_min</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">mid_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">mid_min</span><span class="p">)</span>
                    <span class="n">z0_index</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">mid_min</span><span class="p">,</span> <span class="n">locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">init_side</span> <span class="o">==</span> <span class="s1">&#39;Right&#39;</span><span class="p">:</span>
                    <span class="c1">#z_right =  self.allmin[:, :][self.allmin[:, 0] &gt; interface_pos]</span>
                    <span class="n">all_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allmin</span><span class="p">[:,</span> <span class="p">:][</span><span class="bp">self</span><span class="o">.</span><span class="n">allmin</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">interface_pos</span><span class="p">]</span>
                    <span class="n">mid_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_min</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_min</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">mid_min</span> <span class="o">=</span> <span class="n">all_min</span><span class="p">[</span><span class="n">mid_min</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">mid_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">mid_min</span><span class="p">)</span>
                    <span class="n">z0_index</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">mid_min</span><span class="p">,</span> <span class="n">locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allmin</span><span class="p">[:,</span> <span class="p">:]</span>
                <span class="n">mid_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_min</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_min</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">mid_min</span> <span class="o">=</span> <span class="n">all_min</span><span class="p">[</span><span class="n">mid_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">mid_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">mid_min</span><span class="p">)</span>
                <span class="n">z0_index</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">mid_min</span><span class="p">,</span> <span class="n">locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allmin</span><span class="p">[:,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">manual_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You chose manual initializztion, however you did not supplied an initialization position&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z0_index</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">manual_pos</span><span class="p">,</span><span class="n">all_min</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">manual_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">manual_pos</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">manual_pos</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">z0</span> <span class="o">=</span> <span class="n">locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][</span> <span class="n">manual_pos</span><span class="p">]</span>
                    <span class="n">z0_index</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">all_min</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Your index is out of the range&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">z0_index</span><span class="p">,</span> <span class="n">z0</span></div>

<div class="viewcode-block" id="Stage_2.find_new_interface"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.find_new_interface">[docs]</a>    <span class="k">def</span> <span class="nf">find_new_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        **After updating our spcial grid, and applying the grid density that we calculated at `stage_1`,</span>
<span class="sd">        this method aims to point out the new interface of the updated locpot vector.**</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The new interface position. (in Angstrum).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
            <span class="n">left_material</span> <span class="o">=</span> <span class="n">Locpot_yair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">locpot_bulk_materials</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">is_bulk_material</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">z_added</span> <span class="o">=</span> <span class="p">(</span><span class="n">left_material</span><span class="o">.</span><span class="n">locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">left_material</span><span class="o">.</span><span class="n">locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_left</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">N_added</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">z_added</span>  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_density</span><span class="p">)</span>
            <span class="n">index_new_interface</span><span class="p">,</span> <span class="n">new_interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">find_interface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">temp_index</span><span class="p">,</span> <span class="n">temp_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">temp_index</span> <span class="o">=</span>  <span class="n">temp_index</span> <span class="o">+</span> <span class="n">N_added</span>

            <span class="n">index_new_interface</span><span class="p">,</span> <span class="n">new_interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locp</span><span class="o">.</span><span class="n">find_interface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[</span><span class="n">index_new_interface</span><span class="p">:</span><span class="n">temp_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[</span><span class="n">index_new_interface</span><span class="p">:</span><span class="n">temp_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">index_new_interface</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="o">=</span> <span class="n">index_new_interface</span><span class="p">,</span> <span class="n">new_interface</span>
            <span class="k">return</span> <span class="n">index_new_interface</span><span class="p">,</span> <span class="n">new_interface</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="Stage_2.initialize_psi0"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.initialize_psi0">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_psi0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">init_side</span> <span class="o">=</span> <span class="s1">&#39;Left&#39;</span><span class="p">,</span><span class="n">manual_center</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">manual_z0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">manual_z</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">manual_v</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">To_update</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">manual_psi_dic</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        init_side : str, {&#39;Left&#39;, &#39;Right&#39;}, optional, default: &#39;Left&#39;</span>
<span class="sd">                Enables to choose from what side of the interface to initialize the wave function.</span>
<span class="sd">        manual_center : bool, optional, default: False</span>
<span class="sd">                Enables th choose whether to initialize the wave function at a certain ``z`` coordinate as an input from the user.</span>
<span class="sd">        manual_z0 : float, optional, default: None</span>
<span class="sd">                Manual input for initializing the wave function at a certain desired location. The wave function will be centered at z0_manual.</span>
<span class="sd">        manual_z, manual_v : np.array, array_like, optional, default: None</span>
<span class="sd">                Enables flexibility in initializing `psi0` at a given locpot vector, as ``z_input`` and ``v_input``.</span>
<span class="sd">        To_update : bool, optional, default: True</span>
<span class="sd">                A flag to indicate if the changes that have being made are going to be updated as the instance attributes.</span>
<span class="sd">        manual_psi_dic : dict, optional, default: None</span>
<span class="sd">                The dictionary has to be from the structure of : `{&#39;sigma&#39;: np.float , &#39;k0&#39;: np.float, ... }`</span>
<span class="sd">                It enables to initilize the psi0 as we wish by giving it an input for the relevant parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        psi0 : np.array, array_like</span>
<span class="sd">                Wave-function values vector.</span>
<span class="sd">        locpot : numpy.ndarray, (N,2)</span>
<span class="sd">                The corresponding spatial coordinates vector</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">manual_center</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_initial_position_to_center_psi0</span><span class="p">(</span><span class="n">init_side</span><span class="o">=</span><span class="n">init_side</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_initial_position_to_center_psi0</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">manual_z0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You did not supplied manual z0 to center the initial wacve function. It works &#39;</span>
                      <span class="s1">&#39;as it was not manually set&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                    <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_initial_position_to_center_psi0</span><span class="p">(</span><span class="n">init_side</span><span class="o">=</span><span class="n">init_side</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_initial_position_to_center_psi0</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                    <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_initial_position_to_center_psi0</span><span class="p">(</span><span class="n">init_side</span><span class="o">=</span><span class="n">init_side</span><span class="p">,</span><span class="n">manual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">manual_pos</span><span class="o">=</span><span class="n">manual_z0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_initial_position_to_center_psi0</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">manual_pos</span><span class="o">=</span><span class="n">manual_z0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">manual_psi_dic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">manual_psi_dic</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
            <span class="n">k0</span> <span class="o">=</span> <span class="n">manual_psi_dic</span><span class="p">[</span><span class="s1">&#39;k0&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
            <span class="n">k0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">[</span><span class="s1">&#39;k0&#39;</span><span class="p">]</span>
        <span class="k">if</span>  <span class="n">manual_z</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">manual_v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_most_relevant_z_coordinate_vec</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">manual_z</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">manual_v</span>
        <span class="n">psi0</span> <span class="o">=</span> <span class="n">get_psi0</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Angstrum&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">To_update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span> <span class="o">=</span> <span class="n">get_psi0</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Angstrum&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">[</span><span class="s1">&#39;z0&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">z0</span>
        <span class="k">return</span> <span class="n">psi0</span></div>

<div class="viewcode-block" id="Stage_2.get_most_relevant_z_coordinate_vec"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.get_most_relevant_z_coordinate_vec">[docs]</a>    <span class="k">def</span> <span class="nf">get_most_relevant_z_coordinate_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        z, v : np.array, np.array</span>
<span class="sd">                z coordinate vector and v potential vector. It chooses the most relvant z and v vectors according to the steps that</span>
<span class="sd">                have already taken when running this function.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># This function aims to return the latest and most updated/relevant lopot vector (local potential and spatial</span>
        <span class="c1"># coordinates grid vector.</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elongated_locpot_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged_locpot_vec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">z</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">smooth_function</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">z</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allmin</span> <span class="o">=</span> <span class="n">find_peaks_minima</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allmax</span> <span class="o">=</span> <span class="n">find_peaks_maxima</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="n">v</span></div>

<div class="viewcode-block" id="Stage_2.calculate_E0"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.calculate_E0">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_E0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">z_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">v_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        psi : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance.</span>
<span class="sd">        z_in : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is taken from `locpot_vec[:,0]` attribute of `Stage_2` instance.</span>
<span class="sd">                Vector of the spatial grid. (spatial coordinates)</span>
<span class="sd">        v_in : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is taken from `locpot_vec[:,1]` attribute of `Stage_2` instance.</span>
<span class="sd">                Vector of the local potential.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        E0 : float</span>
<span class="sd">                The expectation values of the total energy.</span>
<span class="sd">        T0 : float</span>
<span class="sd">                The expectation values of the kinetic energy.</span>
<span class="sd">        V0 : float</span>
<span class="sd">                The expectation values of the potnetial energy and potential energy, in [Joul].</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># input verification</span>
        <span class="c1"># ---------------------------------------------------------</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">z_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z_in</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v_in</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_most_relevant_z_coordinate_vec</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">to_column_vec</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">to_column_vec</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">psi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psi0</span> <span class="o">=</span> <span class="n">psi</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_psi0</span><span class="p">()</span>
            <span class="n">psi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi0</span><span class="p">)</span>
        <span class="n">psi0</span> <span class="o">=</span> <span class="n">to_column_vec</span><span class="p">(</span><span class="n">psi0</span><span class="p">)</span>
        <span class="n">psi0</span> <span class="o">=</span> <span class="n">force_psi_units</span><span class="p">(</span><span class="n">psi0</span><span class="p">,</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Meter&#39;</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># ---------------------------------------------------------</span>
        <span class="n">T0num</span> <span class="o">=</span> <span class="n">kinetic_energy_expectation_value</span><span class="p">(</span><span class="n">psi0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="c1"># Calculate the kinetic energy expectation value.</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">to_1D_vec</span><span class="p">(</span><span class="n">z</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Getting dz (or the difference at each consecutive spatial grid points).</span>
        <span class="c1"># calculationg the average potential energy for uniform deltaz</span>
        <span class="n">v0num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">dz</span> <span class="o">*</span> <span class="n">psi0</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">to_column_vec</span><span class="p">(</span><span class="n">to_1D_vec</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">psi0</span><span class="p">))))</span> <span class="c1"># Calculate the potential energy expectation value.</span>

        <span class="c1"># [J]</span>
        <span class="n">v0num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">v0num</span><span class="p">)</span> <span class="c1"># Deleting any redundant axis/columns of the vector.</span>
        <span class="c1"># Finally calcualting the total energy expectation value.</span>
        <span class="n">E0num</span> <span class="o">=</span> <span class="n">T0num</span> <span class="o">+</span> <span class="n">v0num</span>  <span class="c1"># [J]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">E0num</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">T0num</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">v0num</span><span class="p">))</span></div>

<div class="viewcode-block" id="Stage_2.propagate_psi"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.propagate_psi">[docs]</a>    <span class="k">def</span> <span class="nf">propagate_psi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Nt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">dt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">z_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">v_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">path_to_save</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        psi : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance.</span>
<span class="sd">        Nt : int, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance.</span>
<span class="sd">                The number of time-steps.</span>
<span class="sd">        dt : float, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance</span>
<span class="sd">                The size of each time step the wave-function is propagated.</span>
<span class="sd">        z_in : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is taken from `locpot_vec[:,0]` attribute of `Stage_2` instance.</span>
<span class="sd">                Vector of the spatial grid. (spatial coordinates)</span>
<span class="sd">        v_in : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is taken from `locpot_vec[:,1]` attribute of `Stage_2` instance.</span>
<span class="sd">                Vector of the local potential.</span>
<span class="sd">        path_to_save : string, optional, default:None</span>
<span class="sd">                The absolute path to save the figure obtained from the calculation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            This method was built mainly to produce the simulation animation. If ``To_plot`` is not set to `True`,</span>
<span class="sd">            then this function does not take any action.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># input verification</span>
        <span class="c1">#---------------------------------------------------------</span>
        <span class="k">if</span> <span class="n">Nt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Nt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">fs2sec</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">z_check</span><span class="p">,</span> <span class="n">v_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_most_relevant_z_coordinate_vec</span><span class="p">()</span>
        <span class="n">z_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">z_check</span><span class="p">)</span>
        <span class="n">v_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">v_check</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="n">z_check</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">v_check</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">psi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">z_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z_in</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v_in</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_psi0</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">force_psi_units</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Meter&#39;</span><span class="p">)</span>
        <span class="c1"># ---------------------------------------------------------</span>
        <span class="c1"># Creating K grid</span>
        <span class="n">kk</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">create_k_grid</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">kk</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>

        <span class="c1"># wave_funcs = np.zeros((self.Nt, len(psi)), dtype=np.cdouble)</span>
        <span class="c1"># wave_funcs[0, :] = psi</span>
        <span class="c1"># for q in range(1, Nt):</span>
        <span class="c1">#     wave_funcs[q, :] = run_one_time_step(wave_funcs[q-1, :], dt, v, kk)</span>
        <span class="c1"># Temporary structure to store the last two propagation-step of the wave-function.</span>
        <span class="c1"># It has two rows, and the number of columns is as the length of the wave-function vector.</span>
        <span class="n">wave_funcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">psi</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cdouble</span><span class="p">)</span>

        <span class="c1"># Store at the first row the current/initial wave funtion vector.</span>
        <span class="n">wave_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">psi</span>

        <span class="c1"># It enables to plot. In this case&#39; it turned on the simulation animation production.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">To_plot</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating propagation animation...&#39;</span><span class="p">)</span>

            <span class="c1"># Creating plotting objects.</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Creating empty lines and text-box to be later updated at each propagation step</span>
            <span class="c1"># which will be equivalent to be updated at each frame of the simulation animation.</span>
            <span class="n">line1</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$| \psi(t)) |^2$&#39;</span><span class="p">)</span>
            <span class="n">line2</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$real(\psi(t))) $&#39;</span><span class="p">)</span>
            <span class="n">time_text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">),</span>
                                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

            <span class="c1"># Setting axes labels.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e10</span><span class="o">*</span><span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
            <span class="n">pxlabel</span> <span class="o">=</span> <span class="s1">&#39;Position z [A]&#39;</span>
            <span class="n">ptitle</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Interface system $\left| \psi(z,t) \right\rangle$&#39;</span>
            <span class="n">my_fps</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="c1"># animating function</span>
            <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
                <span class="k">nonlocal</span> <span class="n">wave_funcs</span>
                <span class="c1"># For the first step, propagate the initial wave-function.</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">line1</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wave_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-10</span><span class="p">)</span>
                    <span class="n">line2</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">wave_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span><span class="o">*</span><span class="mf">1e-5</span><span class="p">)</span>
                    <span class="n">time_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;t=</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">my_fps</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For all the other steps, propagate the last propagated wave function (from previous step)</span>
                    <span class="c1"># and store it at the second row of the storage-structure we created above.</span>
                    <span class="c1"># After updaing the lines (which are objects to be plotted at the same frame of the anumation</span>
                    <span class="c1"># update this propagation step with the first row, so the next step will act on it.</span>
                    <span class="n">wave_funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">run_one_time_step</span><span class="p">(</span><span class="n">wave_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dt</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span><span class="n">z</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span>
                    <span class="n">line1</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wave_funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-10</span><span class="p">)</span>
                    <span class="n">line2</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="mf">1e10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">wave_funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span><span class="o">*</span><span class="mf">1e-5</span><span class="p">)</span>
                    <span class="n">time_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;t=</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="n">my_fps</span><span class="p">))</span>
                    <span class="n">wave_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">wave_funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># I Decided that each animation should last 10 seconds in real time.</span>


            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$|\psi(z,t)|^2 ,\psi(z,t) $&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ptitle</span><span class="p">)</span>

            <span class="c1"># If we have interface in our system, it plots vertical line at the exact position of the interface.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Interface position&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>  <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Reference Point&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">==</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Reference Point&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>  <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Reference Point&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>  <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Plotting the local potential vs the spatial grid/coordinates below the plot of the wave-function propagation</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="n">z</span><span class="o">*</span><span class="mf">1e10</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Local potential&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">z_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">v_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ind_interface</span><span class="p">,</span> <span class="n">inter_position</span> <span class="o">=</span> <span class="n">find_interface</span><span class="p">(</span><span class="n">z_in</span><span class="p">,</span><span class="n">v_in</span><span class="p">)</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">inter_position</span><span class="p">),</span> <span class="n">ymin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span>
                                <span class="n">ymax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                     <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span><span class="p">,</span><span class="n">ymin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">+</span><span class="mf">0.1</span><span class="p">)</span>
                     <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span>
                                <span class="n">ymax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span>
                            <span class="n">ymax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pxlabel</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$V(z) [eV]$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e10</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">+</span><span class="mf">0.1</span> <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">Nt</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;ani.mp4&#39;</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;ffmpeg&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">my_fps</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;Propagation Animation.mp4&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">))),</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;ffmpeg&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">my_fps</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Propagation Animation creation has been completed successfully!&#39;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Stage_2.set_To_plot"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.set_To_plot">[docs]</a>    <span class="k">def</span> <span class="nf">set_To_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">To_plot</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        To_plot : bool</span>
<span class="sd">                The input from the user, this method aims to set the ``To_plot`` attribute of the instance</span>
<span class="sd">                and enables the plotting feature that implemented in some of the class methods.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">To_plot</span> <span class="o">=</span> <span class="n">To_plot</span></div>

<div class="viewcode-block" id="Stage_2.cumulative_probabilty_through_interface"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.cumulative_probabilty_through_interface">[docs]</a>    <span class="k">def</span> <span class="nf">cumulative_probabilty_through_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">psi</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Nt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">dt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">z_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">v_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="n">check_pos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">path_to_save</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        psi : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance.</span>
<span class="sd">        Nt : int, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance.</span>
<span class="sd">                The number of time-steps.</span>
<span class="sd">        dt : float, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance</span>
<span class="sd">                The size of each time step the wave-function is propagated.</span>
<span class="sd">        z_in : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is taken from `locpot_vec[:,0]` attribute of `Stage_2` instance.</span>
<span class="sd">                Vector of the spatial grid. (spatial coordinates)</span>
<span class="sd">        v_in : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is taken from `locpot_vec[:,1]` attribute of `Stage_2` instance.</span>
<span class="sd">                Vector of the local potential.</span>
<span class="sd">        check_pos : float, optional, default: None</span>
<span class="sd">                In cases where we don&#39;t have an interface and we wish supply a position</span>
<span class="sd">                where the cumulative probability is ggoing to be calculated.</span>
<span class="sd">        path_to_save : string, optional, default:None</span>
<span class="sd">                The absolute path to save the figure obtained from the calculation</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results: numpy.ndarray, (N,2)</span>
<span class="sd">                This is a 2 columns vector, the first column vector represents the # of the time step.</span>
<span class="sd">                The second column vector represents the cumulative probabilty through interface.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># input verification</span>
        <span class="c1">#---------------------------------------------------------</span>
        <span class="k">if</span> <span class="n">Nt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Nt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">fs2sec</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">z_check</span><span class="p">,</span> <span class="n">v_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_most_relevant_z_coordinate_vec</span><span class="p">()</span>
        <span class="n">z_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">z_check</span><span class="p">)</span>
        <span class="n">v_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">v_check</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="n">z_check</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">v_check</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">psi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                 <span class="n">psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialize_psi0</span><span class="p">()</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">z_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z_in</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v_in</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">force_psi_units</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Meter&#39;</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">interface_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interface_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span>
            <span class="n">interface_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">check_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">check_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">check_pos</span><span class="p">)</span>
            <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">check_pos</span>
        <span class="c1"># ---------------------------------------------------------</span>
        <span class="c1"># Creating K grid.</span>
        <span class="n">kk</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">create_k_grid</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">kk</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
        <span class="c1"># Creating initial structure to store all the calculation being made at each step later via the loop.</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">Nt</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">)</span>

        <span class="c1"># Temporary variable to store the wave-function at each step.</span>
        <span class="n">temp_psi</span> <span class="o">=</span> <span class="n">psi</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">Nt</span><span class="p">)):</span>
            <span class="c1"># if this is the first appearance of the loop, propagate the initial wave-function.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">cumulative_probabilty</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">interface_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span>
                <span class="n">temp_psi</span> <span class="o">=</span> <span class="n">run_one_time_step</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span><span class="n">dt</span> <span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">z</span> <span class="p">,</span> <span class="n">kk</span><span class="p">)</span>
            <span class="c1"># Except for the first step of the loop, propagate one-step the current wave-function stored at the temp_psi.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">cumulative_probabilty</span><span class="p">(</span><span class="n">temp_psi</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">interface_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span>
                <span class="n">temp_psi</span> <span class="o">=</span> <span class="n">run_one_time_step</span><span class="p">(</span><span class="n">temp_psi</span><span class="p">,</span><span class="n">dt</span> <span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">z</span> <span class="p">,</span> <span class="n">kk</span><span class="p">)</span>
        <span class="c1"># If we enables to plot, this section is aiming to plot.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">To_plot</span><span class="p">:</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Cumulative Probabilty Through the interface vs simulation time&#39;</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time simulation, in fsec&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative probabilty through the interface&#39;</span><span class="p">)</span>
            <span class="n">plat_val</span> <span class="o">=</span> <span class="n">plateau_val</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">results</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span><span class="o">*</span><span class="n">dt</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">results</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">plat_val</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">plat_val</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                 <span class="n">plat_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">results</span><span class="p">[:</span> <span class="p">,</span> <span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">results</span><span class="p">[:</span> <span class="p">,</span> <span class="mi">0</span><span class="p">]))</span><span class="o">*</span><span class="n">dt</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">results</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Cumulative probailty through the interface is = </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">plat_val</span><span class="p">)))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;cumulative probability through the interface vs simulation time&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;cumulative probability through the interface vs simulation time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="Stage_2.converge_system_size"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.converge_system_size">[docs]</a>    <span class="k">def</span> <span class="nf">converge_system_size</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span><span class="n">psi</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Nt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">dt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">z_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">v_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">To_update</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">Elongate_from_itself</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Multi</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iteration_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">init_side</span> <span class="o">=</span> <span class="s1">&#39;Left&#39;</span><span class="p">,</span>
                             <span class="n">manual_center</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">manual_z0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">manual_z</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">manual_v</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">manual_psi_dic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">path_to_save</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        More accurate name - converge simulation overall time</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        psi : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance.</span>
<span class="sd">        Nt : int, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance.</span>
<span class="sd">                The number of time-steps.</span>
<span class="sd">        dt : float, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance</span>
<span class="sd">                The size of each time step the wave-function is propagated.</span>
<span class="sd">        z_in : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is taken from `locpot_vec[:,0]` attribute of `Stage_2` instance.</span>
<span class="sd">                Vector of the spatial grid. (spatial coordinates)</span>
<span class="sd">        v_in : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is taken from `locpot_vec[:,1]` attribute of `Stage_2` instance.</span>
<span class="sd">                Vector of the local potential.</span>
<span class="sd">        To_update : bool, optional, default: True</span>
<span class="sd">                A flag that indicates whether to update the instance attributes with the calculated converged parameters.</span>
<span class="sd">        Elongate_from_itself : bool, optional, default: True</span>
<span class="sd">                A flag that tells from where to take the bulk-like potential to be</span>
<span class="sd">                inserted during the elongation proccess.</span>
<span class="sd">        Multi : int, optional, default: 2</span>
<span class="sd">                A flag that tells how many time to multiply the inserted potenial during the elongation proccess.</span>
<span class="sd">        iteration_num : int, optional, default: 20</span>
<span class="sd">                How many iteration the convergence proccess will be hold.</span>
<span class="sd">                manual_center : bool, optional, default: False</span>
<span class="sd">                Enables th choose whether to initialize the wave function at a certain ``z`` coordinate as an input from the user.</span>
<span class="sd">                manual_center : bool, optional, default: False</span>
<span class="sd">                Enables th choose whether to initialize the wave function at a certain ``z`` coordinate as an input from the user.</span>
<span class="sd">        init_side : str, {&#39;Left&#39;, &#39;Right&#39;}, optional, default: &#39;Left&#39;</span>
<span class="sd">                For the psi0 initialization. Enables to choose from what side of the interface to initialize the wave function.</span>
<span class="sd">        manual_center : bool, optional, default: False</span>
<span class="sd">                For the psi0 initialization. Enables th choose whether to initialize the wave function at a certain ``z`` coordinate as an input from the user.</span>
<span class="sd">        manual_z0 : float, optional, default: None</span>
<span class="sd">                For the psi0 initialization. Manual input for initializing the wave function at a certain desired location. The wave function will be centered at z0_manual.</span>
<span class="sd">        manual_z, manual_v : np.array, array_like, optional, default: None</span>
<span class="sd">                For the psi0 initialization. Enables flexibility in initializing `psi0` at a given locpot vector, as ``z_input`` and ``v_input``.</span>
<span class="sd">        manual_psi_dic : dict, optional, default: None</span>
<span class="sd">                For the psi0 initialization. The dictionary has to be from the structure of : `{&#39;sigma&#39;: np.float , &#39;k0&#39;: np.float, ... }`</span>
<span class="sd">                It enables to initilize the psi0 as we wish by giving it an input for the relevant parameters.</span>
<span class="sd">        path_to_save : string, optional, default:None</span>
<span class="sd">                The absolute path to save the figure obtained from the calculation</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        converged_z : np.array</span>
<span class="sd">                The converged vector of the spatial grid. (spatial coordinates)</span>
<span class="sd">        converged_v : np.array</span>
<span class="sd">                The converged vector of the local potential</span>
<span class="sd">        converged_psi : np.array</span>
<span class="sd">                The converged wave-function vector.</span>
<span class="sd">        converged_Nt : int</span>
<span class="sd">                The converged time steps that were being made.</span>
<span class="sd">        results: numpy.ndarray, (N,2)</span>
<span class="sd">                This is a 2 columns vector, the first column vector represents the # of the time step.</span>
<span class="sd">                The second column vector represents the cumulative probabilty through interface.</span>
<span class="sd">        simulation_time : float</span>
<span class="sd">                The total time of the simulation. It is given in units of seconds. It is the multiplication of ``Nt*dt``.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># input verification</span>
        <span class="c1">#---------------------------------------------------------</span>
        <span class="k">if</span> <span class="n">Nt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Nt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span>
            <span class="n">Nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">Nt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">fs2sec</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">overall_time</span> <span class="o">=</span> <span class="n">Nt</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">z_check</span><span class="p">,</span> <span class="n">v_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_most_relevant_z_coordinate_vec</span><span class="p">()</span>
        <span class="n">z_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">z_check</span><span class="p">)</span>
        <span class="n">v_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">v_check</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="n">z_check</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">v_check</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">psi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialize_psi0</span><span class="p">(</span><span class="n">init_side</span><span class="o">=</span> <span class="n">init_side</span><span class="p">,</span> <span class="n">manual_center</span><span class="o">=</span> <span class="n">manual_center</span><span class="p">,</span><span class="n">manual_z0</span> <span class="o">=</span> <span class="n">manual_z0</span><span class="p">,</span> <span class="n">manual_z</span> <span class="o">=</span> <span class="n">manual_z</span><span class="p">,</span> <span class="n">manual_v</span> <span class="o">=</span> <span class="n">manual_v</span><span class="p">,</span><span class="n">manual_psi_dic</span><span class="o">=</span><span class="n">manual_psi_dic</span><span class="p">)</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">z_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">z_in</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">v_in</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">force_psi_units</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Meter&#39;</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
        <span class="n">converged_z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="n">converged_v</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">converged_z</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">converged_z</span><span class="p">)</span>
        <span class="n">converged_v</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">converged_v</span><span class="p">)</span>
        <span class="n">converged_psi</span> <span class="o">=</span> <span class="n">psi</span>
        <span class="n">converged_psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_psi0</span><span class="p">(</span><span class="n">manual_z</span><span class="o">=</span><span class="n">converged_z</span><span class="p">,</span> <span class="n">manual_v</span><span class="o">=</span><span class="n">converged_v</span><span class="p">,</span><span class="n">manual_center</span><span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">manual_z0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">[</span><span class="s1">&#39;z0&#39;</span><span class="p">],</span> <span class="n">manual_psi_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">)</span>
        <span class="n">converged_psi</span> <span class="o">=</span> <span class="n">force_psi_units</span><span class="p">(</span><span class="n">converged_psi</span><span class="p">,</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;Meter&#39;</span><span class="p">)</span>
        <span class="n">converged_Nt</span> <span class="o">=</span> <span class="n">Nt</span>
        <span class="n">converged_overall_time</span> <span class="o">=</span> <span class="n">overall_time</span>
        <span class="c1"># ---------------------------------------------------------</span>
        <span class="c1"># Creating K grid</span>
        <span class="n">kk</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">create_k_grid</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">kk</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>

        <span class="c1"># First calculation of cumulative_probabilty_through_interface before entering the loop</span>
        <span class="n">temp_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">To_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_To_plot</span><span class="p">(</span><span class="n">To_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stage_2 converge system size&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First Cumulutive probabilty through the interface calculation&#39;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_probabilty_through_interface</span><span class="p">(</span><span class="n">psi</span> <span class="o">=</span> <span class="n">converged_psi</span><span class="p">,</span> <span class="n">Nt</span> <span class="o">=</span> <span class="n">converged_Nt</span><span class="p">,</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">,</span> <span class="n">z_in</span> <span class="o">=</span> <span class="n">converged_z</span><span class="p">,</span> <span class="n">v_in</span> <span class="o">=</span> <span class="n">converged_v</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished First Cumulutive probabilty through the interface calculation&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_To_plot</span><span class="p">(</span><span class="n">To_plot</span><span class="o">=</span><span class="n">temp_flag</span><span class="p">)</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter for the iterations that are going to be performed.</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;simulation time in sec&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;cumulative probabilty&#39;</span><span class="p">)</span>
        <span class="n">alter_flag</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># True for elongating the locpot, Flase for enlarging Nt.</span>
        <span class="k">if</span> <span class="n">reach_plateau</span><span class="p">(</span><span class="n">results</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">results</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]):</span> <span class="c1"># If the initial state of our system has reached plateau,</span>
                                                     <span class="c1"># There is no need to enter the loop.</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;..............................&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The cumulative probability through the interface has reached plateau before entering the loop.&#39;</span><span class="p">)</span>
            <span class="n">reach_plat</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;iteration = </span><span class="si">{}</span><span class="s1">, Nt = </span><span class="si">{}</span><span class="s1">, length_z = </span><span class="si">{:.2f}</span><span class="s1"> nm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span><span class="n">converged_Nt</span><span class="p">,</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">converged_z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;cumulative probability through the interface vs dt&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;cumulative probability through the interface vs dt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">converged_z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span> <span class="c1"># I decided not to elongate the system longer than 50 nm. However, it does not tell that we reached plateau.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stage_2 converge system size&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;..............................&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The length of the interface system is longer than the limit of 50 nm before entering the loop.&#39;</span><span class="p">)</span>

            <span class="n">reach_plat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reach_plat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># entering loop: conditions: have not arraived plateau, have not exceeded the limit of 50 nm system,</span>
        <span class="c1"># and not got over the specified iterations number.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reach_plat</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stage_2 converge system size&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;..............................................................&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="n">reach_plateau</span><span class="p">(</span><span class="n">results</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">results</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span> <span class="ow">and</span> <span class="n">converged_z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">iteration_num</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Enering The main loop&#39;</span><span class="p">)</span>
            <span class="c1">#if alter_flag: # Alternating procedure at each iteration. One time the system coordinates elongation, the</span>
                <span class="c1"># other time increasing Nt, and then vice versa.</span>
            <span class="c1">#alter_flag = False</span>
            <span class="c1">#mat= self.elongate_interface_potential(from_iteslf=Elongate_from_itself,</span>
            <span class="c1">#                        side_from_itself=&#39;right&#39;,locpot_vector=to_2_column_mat(np.column_stack((converged_z, converged_v))))</span>
            <span class="c1"># converged_z, converged_v = mat.T</span>
            <span class="c1"># converged_z = cons.A2m(converged_z)</span>
            <span class="c1"># converged_v = cons.eV2J(converged_v)</span>
            <span class="c1"># # if we reached more then 10 iterations, and have not yet to go over 50 nm system length,</span>
            <span class="c1"># # it should elongate the system one more time at this current iteration.</span>
            <span class="c1"># if iteration &gt;=10 and converged_z[-1] &gt;= cons.A2m(500) :</span>
            <span class="c1">#     mat = self.elongate_interface_potential(from_iteslf=Elongate_from_itself,</span>
            <span class="c1">#                                                                  side_from_itself=&#39;right&#39;,</span>
            <span class="c1">#                                                                  locpot_vector=to_2_column_mat(</span>
            <span class="c1">#                                                                      np.column_stack(</span>
            <span class="c1">#                                                                          (converged_z, converged_v))))</span>
            <span class="c1">#     converged_z, converged_v = mat.T</span>
            <span class="c1">#     converged_z = cons.A2m(converged_z)</span>
            <span class="c1">#     converged_v = cons.eV2J(converged_v)</span>

        <span class="c1"># else:</span>
        <span class="c1">#     # Increasing Nt by the factor of alpha.</span>
            <span class="n">converged_overall_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">converged_overall_time</span>

            <span class="n">converged_Nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">converged_overall_time</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span>
        <span class="c1">#     alter_flag = True</span>

            <span class="c1"># Adapt the length of the wave-function vector to the new length of the coordinate vector and</span>
            <span class="c1"># the locpot vector. Then re-calculate cumulative_probabilty_through_interface.</span>
            <span class="n">converged_psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_psi0</span><span class="p">(</span><span class="n">manual_z</span><span class="o">=</span><span class="n">converged_z</span><span class="p">,</span> <span class="n">manual_v</span><span class="o">=</span><span class="n">converged_v</span><span class="p">,</span> <span class="n">manual_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                 <span class="n">manual_z0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">[</span><span class="s1">&#39;z0&#39;</span><span class="p">],</span> <span class="n">manual_psi_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">)</span>
            <span class="n">temp_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">To_plot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_To_plot</span><span class="p">(</span><span class="n">To_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_probabilty_through_interface</span><span class="p">(</span><span class="n">psi</span><span class="o">=</span><span class="n">converged_psi</span><span class="p">,</span> <span class="n">Nt</span><span class="o">=</span><span class="n">converged_Nt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                                                                   <span class="n">z_in</span><span class="o">=</span><span class="n">converged_z</span><span class="p">,</span> <span class="n">v_in</span><span class="o">=</span><span class="n">converged_v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_To_plot</span><span class="p">(</span><span class="n">To_plot</span><span class="o">=</span><span class="n">temp_flag</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">results</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;iteration = </span><span class="si">{}</span><span class="s1">, Nt = </span><span class="si">{}</span><span class="s1">, length_z = </span><span class="si">{:.2f}</span><span class="s1"> nm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span><span class="n">converged_Nt</span><span class="p">,</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">converged_z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iteration number </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nt is = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">converged_Nt</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Overall simulation time is = </span><span class="si">{}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">converged_overall_time</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length of z is nm= </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">converged_z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">iteration</span> <span class="o">+=</span><span class="mi">1</span>

            <span class="k">if</span> <span class="n">reach_plateau</span><span class="p">(</span><span class="n">results</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">results</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reached plateau...&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==============================================================&#39;</span><span class="p">)</span>
                <span class="n">reach_plat</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">converged_z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exceeded 50 nm system length&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">iteration_num</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Got over </span><span class="si">{}</span><span class="s1"> iterations&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==============================================================&#39;</span><span class="p">)</span>

        <span class="c1"># If we have not reached plateau, and still have not gone over the specified number of iterations,</span>
        <span class="c1"># enter this loop, while increasing only Nt by the factor of alpha.</span>
        <span class="k">if</span> <span class="n">reach_plat</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">iteration_num</span><span class="p">:</span>
            <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="n">reach_plateau</span><span class="p">(</span><span class="n">results</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">results</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">iteration_num</span><span class="p">:</span>
                <span class="n">converged_overall_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">converged_overall_time</span>
                <span class="n">converged_Nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">converged_overall_time</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span>
                <span class="c1">#converged_Nt = np.int64(self.alpha * converged_Nt)</span>
                <span class="n">converged_psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_psi0</span><span class="p">(</span><span class="n">manual_z</span><span class="o">=</span><span class="n">converged_z</span><span class="p">,</span> <span class="n">manual_v</span><span class="o">=</span><span class="n">converged_v</span><span class="p">,</span> <span class="n">To_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">temp_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">To_plot</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_To_plot</span><span class="p">(</span><span class="n">To_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_probabilty_through_interface</span><span class="p">(</span><span class="n">psi</span><span class="o">=</span><span class="n">converged_psi</span><span class="p">,</span> <span class="n">Nt</span><span class="o">=</span><span class="n">converged_Nt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                                                                       <span class="n">z_in</span><span class="o">=</span><span class="n">converged_z</span><span class="p">,</span> <span class="n">v_in</span><span class="o">=</span><span class="n">converged_v</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_To_plot</span><span class="p">(</span><span class="n">To_plot</span><span class="o">=</span><span class="n">temp_flag</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span> <span class="p">,</span> <span class="n">results</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;iteration = </span><span class="si">{}</span><span class="s1">, Nt = </span><span class="si">{}</span><span class="s1">, length_z = </span><span class="si">{:.2f}</span><span class="s1"> nm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">converged_Nt</span><span class="p">,</span>
                                                                                      <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">converged_z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iteration number </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nt is = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">converged_Nt</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Overall simulation time is = </span><span class="si">{}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">converged_overall_time</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length of z is nm= </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">converged_z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------------------&#39;</span><span class="p">)</span>
                <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">reach_plateau</span><span class="p">(</span><span class="n">results</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">results</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reached plateau...&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==============================================================&#39;</span><span class="p">)</span>
                    <span class="n">reach_plat</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">iteration_num</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Got over </span><span class="si">{}</span><span class="s1"> iterations&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==============================================================&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;cumulative probability through the interface vs dt&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;cumulative probability through the interface vs dt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">To_update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span> <span class="o">=</span> <span class="n">converged_psi</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">=</span> <span class="n">converged_Nt</span>
            <span class="n">converged_z</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">converged_z</span><span class="p">)</span>
            <span class="n">converged_v</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">converged_v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span> <span class="o">=</span> <span class="n">to_2_column_mat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">converged_z</span><span class="p">,</span> <span class="n">converged_v</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">converged_z</span><span class="p">,</span> <span class="n">converged_v</span><span class="p">,</span> <span class="n">converged_psi</span><span class="p">,</span> <span class="n">converged_Nt</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">fs2sec</span><span class="p">(</span><span class="n">converged_Nt</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span></div>


<div class="viewcode-block" id="Stage_2.converge_time_step"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.converge_time_step">[docs]</a>    <span class="k">def</span> <span class="nf">converge_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">psi</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Nt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">dt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">time_sim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">z_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">v_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">To_update</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">To_plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">check_pos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span><span class="n">path_to_save</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        psi : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance.</span>
<span class="sd">        Nt : int, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance.</span>
<span class="sd">                The number of time-steps.</span>
<span class="sd">        dt : float, optional, default: None</span>
<span class="sd">                If not supplied, the default is the wave-function vector attribute of `Stage_2` instance</span>
<span class="sd">                The size of each time step the wave-function is propagated.</span>
<span class="sd">        time_sim : float, optional, default: None</span>
<span class="sd">                If not supplied, it will be calculated from the product ``Nt*dt``.</span>
<span class="sd">                However, it is supplied, it will be taken into account, and the dt will be taken into account too. Then Nt will be recalculated.</span>
<span class="sd">        z_in : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is taken from `locpot_vec[:,0]` attribute of `Stage_2` instance.</span>
<span class="sd">                Vector of the spatial grid. (spatial coordinates)</span>
<span class="sd">        v_in : np.array, optional, default: None</span>
<span class="sd">                If not supplied, the default is taken from `locpot_vec[:,1]` attribute of `Stage_2` instance.</span>
<span class="sd">                Vector of the local potential.</span>
<span class="sd">        To_update : bool, optional, default: True</span>
<span class="sd">                A flag that indicates whether to update the instance attributes with the calculated converged parameters.</span>
<span class="sd">        To_plot : bool, optional, defulat: False</span>
<span class="sd">                A flag to determine whether to plot or not.</span>
<span class="sd">        iterations : int, optional, default: 40</span>
<span class="sd">                A flag the enables the user define how many times the converges test will run.</span>
<span class="sd">        check_pos : float, optional, default: None</span>
<span class="sd">                In cases where we do not have an interface and we wish supply a position</span>
<span class="sd">                where the cumulative probability is ggoing to be calculated at.</span>
<span class="sd">        tol : float, optional, default: 0.005</span>
<span class="sd">                The tolerance value which will be used as the criteria for the convergence test main loop. It compares the relevant values between two consecutive iterations and demands that the difference between them won&#39;t exceeed the tolerance value.</span>
<span class="sd">        path_to_save : string, optional, default:None</span>
<span class="sd">                The absolute path to save the figure obtained from the calculation</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dt : float</span>
<span class="sd">                The converged size of the time step.</span>
<span class="sd">        Nt : int</span>
<span class="sd">                The converged number of the time steps that were being made through the simulation.</span>
<span class="sd">        Total_Energy : list, [[],[],[],[np.array]]</span>
<span class="sd">                 The first cell is the totoal magnitude at the end of the simulation, the second cell hold the first energy value</span>
<span class="sd">                 at the beginning of the simulation, and the third cell holds the size of the time_step = dt at each iteration.</span>
<span class="sd">                 The last cell hold the array with all the calculated energies along the convergence test.</span>
<span class="sd">        Kinetic_Energy : list, [[],[],[],[np.array]]</span>
<span class="sd">                The same data structure as the Total_Energy.</span>
<span class="sd">        Potential_Energy : list, [[],[],[],[np.array]]</span>
<span class="sd">                The same data structure as the Total_Energy.</span>
<span class="sd">        prob_current : list, [[],[],[],[np.array]]</span>
<span class="sd">                The same data structure as the Total_Energy.</span>
<span class="sd">        Cumulative_Prob : list, [[],[],[],[np.array]]</span>
<span class="sd">                The same data structure as the Total_Energy.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">#%% input verification</span>
        <span class="k">if</span> <span class="n">Nt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Nt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">fs2sec</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_sim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_sim</span> <span class="o">=</span> <span class="n">Nt</span><span class="o">*</span><span class="n">dt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">fs2sec</span><span class="p">(</span><span class="n">time_sim</span><span class="p">)</span>
            <span class="n">Nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">time_sim</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">z_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z_in</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v_in</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">psi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialize_psi0</span><span class="p">()</span>
            <span class="n">psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi0</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">force_psi_units</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;Meter&#39;</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
        <span class="c1"># Check whetehr our system contains an interface.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Has_interface</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">interface_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_interface</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interface_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_interface</span>
            <span class="n">interface_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">check_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">check_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">check_pos</span><span class="p">)</span>
            <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">check_pos</span>
        <span class="n">z_ind</span><span class="p">,</span> <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">A2m</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">)</span>
        <span class="n">z_axis</span> <span class="o">=</span> <span class="n">z</span> <span class="o">==</span> <span class="n">interface_pos</span>
        <span class="c1"># ---------------------------------------------------------</span>

        <span class="c1"># Creating K grid</span>
        <span class="n">kk</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">create_k_grid</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">kk</span> <span class="o">=</span> <span class="n">to_1D_vec</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># A data structure that holds the wave-function vector of the last step and of the current step.</span>
        <span class="n">Wave_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">psi</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>




        <span class="c1"># %% A function to help integrating thourgh the convergence</span>
        <span class="k">def</span> <span class="nf">integrate_trapz</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">to_1D_vec</span><span class="p">(</span><span class="n">vector</span><span class="p">),</span><span class="n">dx</span> <span class="o">=</span> <span class="n">df</span><span class="p">)))</span>


        <span class="c1">#%%  A data structure holds calculations being made at each iteration - Energy_&lt;&gt; Vs dt - the time steps.</span>
        <span class="c1"># First cell is the Totoal magnitude at the end of the simulation, the second cell hold the first energy value</span>
        <span class="c1"># at the beginning of the simulation, and the third cell holds the size of the time_step = dt at each iteration.</span>
        <span class="c1"># The last cell hold the list with all the calculated energies along the convergence test.</span>
        <span class="n">temp_dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">temp_Nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">time_sim</span><span class="o">/</span><span class="n">temp_dt</span><span class="p">)</span>
        <span class="n">Nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">Nt</span><span class="p">)</span>
        <span class="n">Kinetic_Energy</span> <span class="o">=</span> <span class="p">[[[],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)],[[],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">temp_Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)]]</span>
        <span class="n">Potential_Energy</span> <span class="o">=</span> <span class="p">[[[],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)],[[],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">temp_Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)]]</span>
        <span class="n">Total_Energy</span> <span class="o">=</span> <span class="p">[[[],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)],[[],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">temp_Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)]]</span>
        <span class="n">Kinetic_Energy_temp</span><span class="p">,</span> <span class="n">Potential_Energy_temp</span><span class="p">,</span>  <span class="n">Total_Energy_temp</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="c1"># %% A data structure holds calculations being made at each iteration - Probabilty current Vs dt - the time steps. The</span>
        <span class="c1"># equivalent values regarding the above data structures.</span>
        <span class="n">prob_current</span> <span class="o">=</span> <span class="p">[[[],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)],[[],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">temp_Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)]]</span>
        <span class="n">Cumulative_Prob</span> <span class="o">=</span> <span class="p">[[[],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)],[[],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">temp_Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)]]</span>
        <span class="n">prob_current_temp</span><span class="p">,</span> <span class="n">Cumulative_Prob_temp</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="n">temp_psi</span> <span class="o">=</span> <span class="n">psi</span>

        <span class="c1"># %% First and second iterations before entering the loop:</span>

        <span class="c1"># iteration = 0:</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prob_current</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="n">Total_Energy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="n">Cumulative_Prob</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="n">Kinetic_Energy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="n">Potential_Energy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="c1"># iteration = 1:</span>
        <span class="n">prob_current</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">Total_Energy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">Cumulative_Prob</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">Kinetic_Energy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">Potential_Energy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>

        <span class="c1"># The first two iterations we are being performed outside the main &#39;while&#39; loop since the &#39;while condition&#39; takes into account</span>
        <span class="c1"># the last two iterations.</span>

        <span class="c1"># A varibale that helps to correct the overall time simulation at the first</span>
        <span class="c1"># two iterations.</span>
        <span class="n">temp_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">Nt</span><span class="p">,</span> <span class="n">temp_Nt</span><span class="p">]</span>

        <span class="c1">#%% Printing during the first two iterations.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stage_2 converge Time step&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;..............................&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">temp_count</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                <span class="c1"># if this is the first appearance of the loop, propagate the initial wave-function.</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">psi</span>
                    <span class="n">prob_current_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">calculate_probability_current</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span><span class="n">kk</span><span class="p">)[</span><span class="n">z_axis</span><span class="p">])</span>
                    <span class="n">Cumulative_Prob_temp</span> <span class="o">=</span> <span class="n">cumulative_probabilty</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">z</span><span class="p">,</span> <span class="n">interface_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">Total_Energy_temp</span><span class="p">,</span> <span class="n">Kinetic_Energy_temp</span><span class="p">,</span> <span class="n">Potential_Energy_temp</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_E0</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
                                                                                                      <span class="n">z_in</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">v_in</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_current_temp</span>
                    <span class="n">Cumulative_Prob</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cumulative_Prob_temp</span>
                    <span class="n">Kinetic_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Kinetic_Energy_temp</span>
                    <span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Total_Energy_temp</span>
                    <span class="n">Potential_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Potential_Energy_temp</span>

                    <span class="n">Wave_function</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">run_one_time_step</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dt</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span>
                <span class="c1"># Except for the first step of the loop, propagate one-step the current wave-function stored at the temp_psi.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Wave_function</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">prob_current_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">calculate_probability_current</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span><span class="n">kk</span><span class="p">)[</span><span class="n">z_axis</span><span class="p">])</span>
                    <span class="n">Cumulative_Prob_temp</span> <span class="o">=</span> <span class="n">cumulative_probabilty</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">z</span><span class="p">,</span> <span class="n">interface_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">Total_Energy_temp</span><span class="p">,</span> <span class="n">Kinetic_Energy_temp</span><span class="p">,</span> <span class="n">Potential_Energy_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_E0</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
                                                                                                      <span class="n">z_in</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">v_in</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_current_temp</span>
                    <span class="n">Cumulative_Prob</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cumulative_Prob_temp</span>
                    <span class="n">Kinetic_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Kinetic_Energy_temp</span>
                    <span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Total_Energy_temp</span>
                    <span class="n">Potential_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Potential_Energy_temp</span>
                    <span class="n">Wave_function</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">run_one_time_step</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dt</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Iteration Number </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dt = </span><span class="si">{:.4e}</span><span class="s1"> fsec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">dt</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The difference in Total Energy between the final propagation step and the first propagation step is = </span><span class="si">{:.3f}</span><span class="s2"> eV&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]))))</span>
            <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;First Value for probabilty current  = </span><span class="si">{:.4e}</span><span class="s1"> e/A&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">elif</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Probabilty current difference between the last two iterations = </span><span class="si">{:.4e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))))</span>
            <span class="c1"># ax_0.plot(np.arange(0,Total_Energy[iteration][0]*len(Total_Energy[iteration][1]),Total_Energy[iteration][0]),</span>
            <span class="c1">#           cons.J2eV(Total_Energy[iteration][1]), &#39;--&#39;, linewidth=2,label=r&#39;iteration number {}&#39;.format(iteration))</span>
            <span class="c1"># ax_0_1.plot(prob_current[iteration][0]*np.arange(0,len(prob_current[iteration][1]),1),</span>
            <span class="c1">#           prob_current[iteration][1], &#39;--&#39;, linewidth=2,label=r&#39;iteration number {}&#39;.format(iteration))</span>
            <span class="c1"># plt.legend()</span>
            <span class="c1"># plt.show()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------------------------------------------------------&quot;</span><span class="p">)</span>

            <span class="c1"># %% Setting last the dynamic variables after the first two iterations before enetering the main loop,</span>
            <span class="n">former_dt</span> <span class="o">=</span> <span class="n">dt</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>  <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="n">former_Nt</span> <span class="o">=</span> <span class="n">Nt</span>
            <span class="n">Nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">time_sim</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
            <span class="n">Wave_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">psi</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
            <span class="n">temp_psi</span> <span class="o">=</span> <span class="n">psi</span>
            <span class="n">iteration</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&lt;=</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">tol</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Probability current got converged. Its difference between the last two iterations = </span><span class="si">{:.4e}</span><span class="s1"> e/A&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=======================================================================&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total energy conserved. Its difference between the final propagation step and the first propagation step is = </span><span class="si">{:.4e}</span><span class="s1"> eV&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">])))))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final dt is </span><span class="si">{:.4e}</span><span class="s1"> fsec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">dt</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=======================================================================&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">To_plot</span><span class="p">:</span>
                    <span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;serif&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>
                    <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Cumulative Probabilty Through the interface&#39;</span><span class="p">)</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Cumulative_Prob</span><span class="p">])),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Cumulative_Prob</span><span class="p">]),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Cumulative Probabilty&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Cumulative_Prob</span><span class="p">])),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Cumulative_Prob</span><span class="p">]),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;dt, [$fsec$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Cumulative Probabilty&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Cumulative probabilty vs dt&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="nb">list</span><span class="p">(</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;Cumulative probabilty vs dt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span><span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

                    <span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;serif&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>
                    <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Probabilty current through the interface&#39;</span><span class="p">)</span>
                    <span class="n">ax_1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="n">ax_1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prob_current</span><span class="p">])),</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prob_current</span><span class="p">]),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                              <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Probabilty current $\frac</span><span class="si">{e}</span><span class="s1">{\AA}$&#39;</span><span class="p">)</span>
                    <span class="n">ax_1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prob_current</span><span class="p">])),</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prob_current</span><span class="p">]),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">ax_1</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
                    <span class="n">ax_1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;dt, [$fsec$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">ax_1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Probabilty current, $\frac</span><span class="si">{e}</span><span class="s1">{\AA}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">ax_1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
                    <span class="c1"># ax_1.ticklabel_format(useOffset=True, useMathText=True, style=&#39;sci&#39;)</span>
                    <span class="c1"># ax_1.yaxis.set_major_formatter(FormatStrFormatter(&#39;%.3f&#39;))</span>
                    <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Probabilty current vs dt&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="nb">list</span><span class="p">(</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;Probabilty current vs dt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

                    <span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;serif&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>
                    <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Probabilty current at the interface Vs time&#39;</span><span class="p">)</span>
                    <span class="n">ax_2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># ax_2.ticklabel_format(useOffset=True, useMathText=True, style=&#39;sci&#39;)</span>
                    <span class="c1"># ax_2.yaxis.set_major_formatter(FormatStrFormatter(&#39;%.2e&#39;))</span>
                    <span class="n">ax_2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">former_Nt</span><span class="p">))),</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                              <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Probabilty current $J_{{z=z_{{interface}}}}$, Transmission coefficient is : </span><span class="si">{:.3f}</span><span class="s1"> $\frac{{e}}{{\AA}}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                  <span class="n">integrate_trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">prob_current</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="c1"># ax_2.plot(np.array(self.cons.sec2fs(prob_current[-1][0] * np.arange(0,Nt))), np.array(prob_current[-1][1]), &#39;--&#39;,linewidth=2)</span>
                    <span class="n">ax_2</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
                    <span class="n">ax_2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time of simulation, [$fsec$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">ax_2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Probabilty current, $J_{z=z_</span><span class="si">{interface}</span><span class="s1">}$  $\frac</span><span class="si">{e}</span><span class="s1">{\AA}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">ax_2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Probabilty current vs Time of simulation&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="nb">list</span><span class="p">(</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;Probabilty current vs Time of simulation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

                    <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>
                    <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Convergence plots Vs dt , time-steps&#39;</span><span class="p">)</span>
                    <span class="n">Ax_i</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">Ax_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

                    <span class="n">Ax_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot; dt, time step in fsec&quot;</span><span class="p">)</span>
                    <span class="n">Ax_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Total  Energy_{final-initial}$,  $E_</span><span class="si">{tot}</span><span class="s2">$ [eV]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                    <span class="n">Ax_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Kinetic  energy_{final-initial}$,  $T_</span><span class="si">{kin}</span><span class="s2">$ [eV]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                    <span class="n">Ax_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Potential  energy_{final-initial}$,  $V_</span><span class="si">{pot}</span><span class="s2">$ [eV]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

                    <span class="c1"># Ax_i[0].ticklabel_format(useOffset=True, useMathText=True, style=&#39;sci&#39;)</span>
                    <span class="c1"># Ax_i[0].yaxis.set_major_formatter(FormatStrFormatter(&#39;%.2e&#39;))</span>
                    <span class="n">Ax_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Total_Energy</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Total_Energy</span><span class="p">])),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                                 <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total Energy&#39;</span><span class="p">)</span>
                    <span class="n">Ax_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Total_Energy</span><span class="p">])),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Total_Energy</span><span class="p">])),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

                    <span class="c1"># Ax_i[1].ticklabel_format(useOffset=True, useMathText=True, style=&#39;sci&#39;)</span>
                    <span class="c1"># Ax_i[1].yaxis.set_major_formatter(FormatStrFormatter(&#39;%.2e&#39;))</span>
                    <span class="n">Ax_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Kinetic_Energy</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Kinetic_Energy</span><span class="p">])),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                                 <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Kinetic Energy&#39;</span><span class="p">)</span>
                    <span class="n">Ax_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Kinetic_Energy</span><span class="p">])),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Kinetic_Energy</span><span class="p">])),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

                    <span class="c1"># Ax_i[2].ticklabel_format(useOffset=True, useMathText=True, style=&#39;sci&#39;)</span>
                    <span class="c1"># Ax_i[2].yaxis.set_major_formatter(FormatStrFormatter(&#39;%.2e&#39;))</span>
                    <span class="n">Ax_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Potential_Energy</span><span class="p">])),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Potential_Energy</span><span class="p">])),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span>
                                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                                 <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Potential Energy&#39;</span><span class="p">)</span>
                    <span class="n">Ax_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Potential_Energy</span><span class="p">])),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Potential_Energy</span><span class="p">])),</span>
                                 <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">Ax_i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
                        <span class="n">Ax_i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Convergence test energies vs time&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="nb">list</span><span class="p">(</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span><span class="s1">&#39;Convergence test energies vs time&#39;</span> <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>


                <span class="k">if</span> <span class="n">To_update</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">=</span> <span class="n">Nt</span>
                <span class="k">return</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Nt</span><span class="p">,</span> <span class="n">Total_Energy</span><span class="p">,</span> <span class="n">Kinetic_Energy</span><span class="p">,</span> <span class="n">Potential_Energy</span><span class="p">,</span> <span class="n">prob_current</span><span class="p">,</span> <span class="n">Cumulative_Prob</span>


        <span class="c1">#%%  Entering the main &#39;while&#39; loop with iteration equals to 2.</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">while</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">iterations</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&lt;=</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">tol</span><span class="p">)))</span> <span class="p">:</span>
            <span class="c1"># Before we propagating the wave function, we would like to save the magnitude of dt in the current iteration.</span>

            <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">prob_current</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
                <span class="n">Total_Energy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
                <span class="n">Cumulative_Prob</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
                <span class="n">Kinetic_Energy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
                <span class="n">Potential_Energy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prob_current</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)])</span>
                <span class="n">Total_Energy</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)])</span>
                <span class="n">Cumulative_Prob</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)])</span>
                <span class="n">Kinetic_Energy</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)])</span>
                <span class="n">Potential_Energy</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)])</span>

            <span class="c1"># For each time-step size, we propagate the wave-function Nt times. We want to check whether the energy and the transmision coeffient are getting converged</span>
            <span class="c1"># for increasin the dt magnitude.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="p">):</span>
                <span class="c1"># if this is the first appearance of the loop, propagate the initial wave-function.</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">psi</span>
                    <span class="n">prob_current_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">calculate_probability_current</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span><span class="n">kk</span><span class="p">)[</span><span class="n">z_axis</span><span class="p">])</span>
                    <span class="n">Cumulative_Prob_temp</span> <span class="o">=</span> <span class="n">cumulative_probabilty</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">z</span><span class="p">,</span> <span class="n">interface_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">Total_Energy_temp</span><span class="p">,</span> <span class="n">Kinetic_Energy_temp</span><span class="p">,</span> <span class="n">Potential_Energy_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_E0</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span><span class="n">z_in</span><span class="o">=</span><span class="n">z</span><span class="p">,</span><span class="n">v_in</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

                    <span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_current_temp</span>
                    <span class="n">Cumulative_Prob</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cumulative_Prob_temp</span>
                    <span class="n">Kinetic_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Kinetic_Energy_temp</span>
                    <span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Total_Energy_temp</span>
                    <span class="n">Potential_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Potential_Energy_temp</span>

                    <span class="n">Wave_function</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">run_one_time_step</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span><span class="n">dt</span> <span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">z</span> <span class="p">,</span> <span class="n">kk</span><span class="p">)</span>

                <span class="c1"># Except for the first step of the loop, propagate one-step the current wave-function stored at the temp_psi.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span>  <span class="n">Wave_function</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">prob_current_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">calculate_probability_current</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span><span class="n">kk</span><span class="p">)[</span><span class="n">z_axis</span><span class="p">])</span>
                    <span class="n">Cumulative_Prob_temp</span> <span class="o">=</span> <span class="n">cumulative_probabilty</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">z</span><span class="p">,</span> <span class="n">interface_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">Total_Energy_temp</span><span class="p">,</span> <span class="n">Kinetic_Energy_temp</span><span class="p">,</span> <span class="n">Potential_Energy_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_E0</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span><span class="n">z_in</span><span class="o">=</span><span class="n">z</span><span class="p">,</span><span class="n">v_in</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

                    <span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_current_temp</span>
                    <span class="n">Cumulative_Prob</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cumulative_Prob_temp</span>
                    <span class="n">Kinetic_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Kinetic_Energy_temp</span>
                    <span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Total_Energy_temp</span>
                    <span class="n">Potential_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Potential_Energy_temp</span>

                    <span class="n">Wave_function</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">run_one_time_step</span><span class="p">(</span><span class="n">Wave_function</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dt</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span>

            <span class="c1"># Before we decreasing dt for the next iteration, we should check whether the next loop will be performed.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Iteration Number </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dt = </span><span class="si">{:.4e}</span><span class="s1"> fsec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">dt</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The difference in Total Energy between the final propagation step and the first propagation step is = </span><span class="si">{:.4e}</span><span class="s2"> eV&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">]))))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Probabilty current difference between the last two iterations = </span><span class="si">{:.4e}</span><span class="s1"> e/A&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------------------------------------------------------&quot;</span><span class="p">)</span>

            <span class="k">if</span>   <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">iterations</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&lt;=</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">eV2J</span><span class="p">(</span><span class="n">tol</span><span class="p">)))</span> <span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>  <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
                <span class="n">Nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">time_sim</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
                <span class="n">Wave_function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">psi</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
                <span class="n">temp_psi</span> <span class="o">=</span> <span class="n">psi</span>
                <span class="n">iteration</span> <span class="o">+=</span><span class="mi">1</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">Nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">time_sim</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iteration</span>  <span class="o">&lt;</span> <span class="n">iterations</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Got over </span><span class="si">{}</span><span class="s1"> interations&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iteration</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=======================================================================&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Probability current got converged. Its difference between the last two iterations = </span><span class="si">{:.4e}</span><span class="s1"> e/A&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">integrate_trapz</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">prob_current</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=======================================================================&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total energy conserved. Its difference between the final propagation step and the first propagation step is = </span><span class="si">{:.4e}</span><span class="s1"> eV&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">Total_Energy</span><span class="p">[</span><span class="n">iteration</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">4</span><span class="p">])))))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final dt is </span><span class="si">{:.4e}</span><span class="s1"> fsec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">dt</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=======================================================================&quot;</span><span class="p">)</span>
        <span class="c1"># If we enabled the plotting option for this class instance, namely : self.To_plot = True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">To_plot</span><span class="p">:</span>
            <span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;serif&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Cumulative Probabilty Through the interface&#39;</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Cumulative_Prob</span><span class="p">])),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Cumulative_Prob</span><span class="p">]),</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Cumulative Probabilty&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Cumulative_Prob</span><span class="p">])),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Cumulative_Prob</span><span class="p">]),</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;dt, [$fsec$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Cumulative Probabilty&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Cumulative probabilty vs dt&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;Cumulative probabilty vs dt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>


            <span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;serif&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Probabilty current through the interface&#39;</span><span class="p">)</span>
            <span class="n">ax_1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">ax_1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prob_current</span><span class="p">]))</span> <span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prob_current</span><span class="p">]),</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Probabilty current $\frac</span><span class="si">{e}</span><span class="s1">{\AA}$&#39;</span><span class="p">)</span>
            <span class="n">ax_1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prob_current</span><span class="p">])),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prob_current</span><span class="p">]),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax_1</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax_1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;dt, [$fsec$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax_1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Probabilty current, $\frac</span><span class="si">{e}</span><span class="s1">{\AA}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax_1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
           <span class="c1"># ax_1.ticklabel_format(useOffset=True, useMathText=True, style=&#39;sci&#39;)</span>
           <span class="c1"># ax_1.yaxis.set_major_formatter(FormatStrFormatter(&#39;%.3f&#39;))</span>
            <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Probabilty current vs dt&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;Probabilty current vs dt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>


            <span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;serif&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Probabilty current at the interface Vs time&#39;</span><span class="p">)</span>
            <span class="n">ax_2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1">#ax_2.ticklabel_format(useOffset=True, useMathText=True, style=&#39;sci&#39;)</span>
            <span class="c1">#ax_2.yaxis.set_major_formatter(FormatStrFormatter(&#39;%.2e&#39;))</span>
            <span class="n">ax_2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nt</span><span class="p">)))</span> <span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Probabilty current $J_{{z=z_{{interface}}}}$, Transmission coefficient is : </span><span class="si">{:.3f}</span><span class="s1"> $\frac{{e}}{{\AA}}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">integrate_trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob_current</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span><span class="n">prob_current</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
            <span class="c1">#ax_2.plot(np.array(self.cons.sec2fs(prob_current[-1][0] * np.arange(0,Nt))), np.array(prob_current[-1][1]), &#39;--&#39;,linewidth=2)</span>
            <span class="n">ax_2</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax_2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time of simulation, [$fsec$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax_2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Probabilty current, $J_{z=z_</span><span class="si">{interface}</span><span class="s1">}$  $\frac</span><span class="si">{e}</span><span class="s1">{\AA}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax_2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Probabilty current vs Time of simulation&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;Probabilty current vs Time of simulation&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>


            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Convergence plots Vs dt , time-steps&#39;</span><span class="p">)</span>
            <span class="n">Ax_i</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">Ax_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

            <span class="n">Ax_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot; dt, time step in fsec&quot;</span><span class="p">)</span>
            <span class="n">Ax_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Total  Energy_{final-initial}$,  $E_</span><span class="si">{tot}</span><span class="s2">$ [eV]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">Ax_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Kinetic  energy_{final-initial}$,  $T_</span><span class="si">{kin}</span><span class="s2">$ [eV]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">Ax_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$Potential  energy_{final-initial}$,  $V_</span><span class="si">{pot}</span><span class="s2">$ [eV]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

            <span class="c1">#Ax_i[0].ticklabel_format(useOffset=True, useMathText=True, style=&#39;sci&#39;)</span>
            <span class="c1">#Ax_i[0].yaxis.set_major_formatter(FormatStrFormatter(&#39;%.2e&#39;))</span>
            <span class="n">Ax_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Total_Energy</span><span class="p">])),</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Total_Energy</span><span class="p">])),</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total Energy&#39;</span><span class="p">)</span>
            <span class="n">Ax_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Total_Energy</span><span class="p">])),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Total_Energy</span><span class="p">])),</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>


            <span class="c1">#Ax_i[1].ticklabel_format(useOffset=True, useMathText=True, style=&#39;sci&#39;)</span>
            <span class="c1">#Ax_i[1].yaxis.set_major_formatter(FormatStrFormatter(&#39;%.2e&#39;))</span>
            <span class="n">Ax_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Kinetic_Energy</span><span class="p">])),</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Kinetic_Energy</span><span class="p">])),</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Kinetic Energy&#39;</span><span class="p">)</span>
            <span class="n">Ax_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Kinetic_Energy</span><span class="p">])),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Kinetic_Energy</span><span class="p">])),</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>


            <span class="c1">#Ax_i[2].ticklabel_format(useOffset=True, useMathText=True, style=&#39;sci&#39;)</span>
            <span class="c1">#Ax_i[2].yaxis.set_major_formatter(FormatStrFormatter(&#39;%.2e&#39;))</span>
            <span class="n">Ax_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Potential_Energy</span><span class="p">])),</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Potential_Energy</span><span class="p">])),</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Potential Energy&#39;</span><span class="p">)</span>
            <span class="n">Ax_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">sec2fs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Potential_Energy</span><span class="p">])),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Potential_Energy</span><span class="p">])),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>


            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">Ax_i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
                <span class="n">Ax_i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Convergence test energies vs time&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;Convergence test energies vs time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">To_update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">=</span> <span class="n">Nt</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final dt = </span><span class="si">{:.5e}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">fs2sec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final k0 = </span><span class="si">{:.5e}</span><span class="s1"> 1/Ang&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">[</span><span class="s1">&#39;k0&#39;</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final sigma = </span><span class="si">{:.5g}</span><span class="s1"> Ang&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">])))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;E0  = </span><span class="si">{:.5g}</span><span class="s1"> eV&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">[</span><span class="s1">&#39;E0&#39;</span><span class="p">])))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;N = </span><span class="si">{:.5g}</span><span class="s1"> partitions&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">])))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nt = </span><span class="si">{:.5g}</span><span class="s1"> time steps&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nt</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Nt</span><span class="p">,</span> <span class="n">Total_Energy</span><span class="p">,</span> <span class="n">Kinetic_Energy</span><span class="p">,</span><span class="n">Potential_Energy</span><span class="p">,</span><span class="n">prob_current</span><span class="p">,</span> <span class="n">Cumulative_Prob</span></div>


<div class="viewcode-block" id="Stage_2.model_interface"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.model_interface">[docs]</a>    <span class="k">def</span> <span class="nf">model_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface_initial_pos</span><span class="p">,</span> <span class="n">interface_final_pos</span><span class="p">,</span><span class="n">region_initial_pos</span><span class="p">,</span><span class="n">region_final_pos</span><span class="p">,</span><span class="n">Delta_pos</span><span class="p">,</span> <span class="n">z_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">v_in</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">interface_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">path_to_save</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        interface_initial_pos :</span>
<span class="sd">        interface_final_pos :</span>
<span class="sd">        region_initial_pos :</span>
<span class="sd">        region_final_pos :</span>
<span class="sd">        Delta_pos :</span>
<span class="sd">        z_in :</span>
<span class="sd">        v_in :</span>
<span class="sd">        interface_pos :</span>
<span class="sd">        path_to_save :</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">interface_initial_pos</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span> <span class="n">interface_initial_pos</span><span class="p">)</span>
        <span class="n">interface_final_pos</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">interface_final_pos</span><span class="p">)</span>
        <span class="n">interface_pos</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span> <span class="n">interface_pos</span><span class="p">)</span>
        <span class="n">region_initial_pos</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">region_initial_pos</span><span class="p">)</span>
        <span class="n">region_final_pos</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">region_final_pos</span><span class="p">)</span>
        <span class="n">Delta_pos</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">Delta_pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">z_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">z</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_locpot_vec</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">z_in</span><span class="p">,</span> <span class="n">v_in</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">ind_interface_initial_pos</span><span class="p">,</span> <span class="n">interface_initial_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">interface_initial_pos</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">ind_interface_final_pos</span><span class="p">,</span> <span class="n">interface_final_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">interface_final_pos</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">new_z_interface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">[(</span><span class="n">interface_initial_pos</span> <span class="o">&lt;=</span> <span class="n">z</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">interface_final_pos</span><span class="p">)])</span>
        <span class="n">new_v_interface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">[(</span><span class="n">interface_initial_pos</span> <span class="o">&lt;=</span> <span class="n">z</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">interface_final_pos</span><span class="p">)])</span>
        <span class="n">ind_region_initial_pos</span><span class="p">,</span> <span class="n">region_initial_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">region_initial_pos</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">ind_region_final_pos</span><span class="p">,</span> <span class="n">region_final_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">region_final_pos</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">new_z_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">[(</span><span class="n">region_initial_pos</span> <span class="o">&lt;=</span> <span class="n">z</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">region_final_pos</span><span class="p">)])</span>
        <span class="n">new_v_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">[(</span><span class="n">region_initial_pos</span> <span class="o">&lt;=</span> <span class="n">z</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">region_final_pos</span><span class="p">)])</span>

        <span class="n">ind_Delta</span><span class="p">,</span> <span class="n">Delta_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">Delta_pos</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="c1"># ind_sigma, sigma_pos = find_closest_value_in_array(sigma_pos, z)</span>
        <span class="n">sigma_pos</span> <span class="o">=</span> <span class="n">interface_final_pos</span>
        <span class="n">ind_phi</span><span class="p">,</span><span class="n">phi_pos</span> <span class="o">=</span> <span class="n">find_closest_value_in_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">[(</span><span class="n">region_initial_pos</span> <span class="o">&lt;=</span> <span class="n">z</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">region_final_pos</span><span class="p">)])),</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">phi_pos</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">ind_phi</span><span class="p">]</span>
        <span class="n">phi_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">ind_phi</span><span class="p">])</span>
        <span class="n">Delta_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">ind_Delta</span><span class="p">])</span>

        <span class="n">z_left_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_z_region</span><span class="p">[</span> <span class="p">(</span><span class="n">new_z_region</span> <span class="o">&lt;=</span> <span class="n">new_z_interface</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">])</span>
        <span class="n">v_left_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_v_region</span><span class="p">[</span> <span class="p">(</span><span class="n">new_z_region</span> <span class="o">&lt;=</span> <span class="n">new_z_interface</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">])</span>
        <span class="n">z_right_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_z_region</span><span class="p">[</span> <span class="p">(</span><span class="n">new_z_region</span> <span class="o">&gt;=</span> <span class="n">new_z_interface</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">v_right_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_v_region</span><span class="p">[</span> <span class="p">(</span><span class="n">new_z_region</span> <span class="o">&gt;=</span> <span class="n">new_z_interface</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>

        <span class="n">left_region_maxima</span> <span class="o">=</span> <span class="n">find_peaks_maxima</span><span class="p">(</span><span class="n">z_left_region</span><span class="p">,</span><span class="n">v_left_region</span><span class="p">,</span><span class="n">ignore_local_maxima</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">left_region_average_maxima_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">left_region_maxima</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">::]))</span>
        <span class="n">right_region_maxima</span> <span class="o">=</span> <span class="n">find_peaks_maxima</span><span class="p">(</span><span class="n">z_right_region</span><span class="p">,</span><span class="n">v_right_region</span><span class="p">,</span><span class="n">ignore_local_maxima</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">right_region_average_maxima_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">right_region_maxima</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>

        <span class="n">left_region_minima</span> <span class="o">=</span> <span class="n">find_peaks_minima</span><span class="p">(</span><span class="n">z_left_region</span><span class="p">,</span><span class="n">v_left_region</span><span class="p">,</span><span class="n">ignore_local_minima</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">left_region_average_minima_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">left_region_minima</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">::]))</span>
        <span class="n">right_region_minima</span> <span class="o">=</span> <span class="n">find_peaks_minima</span><span class="p">(</span><span class="n">z_right_region</span><span class="p">,</span><span class="n">v_right_region</span><span class="p">,</span><span class="n">ignore_local_minima</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">right_region_average_minima_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="n">right_region_minima</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>


        <span class="n">first_two_maxima_from_left</span> <span class="o">=</span>  <span class="n">left_region_maxima</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">::]</span>
        <span class="n">first_two_maxima_from_right</span> <span class="o">=</span> <span class="n">right_region_maxima</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">first_two_minima_from_left</span> <span class="o">=</span>  <span class="n">left_region_minima</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">::]</span>
        <span class="n">first_two_minima_from_right</span> <span class="o">=</span> <span class="n">right_region_minima</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>



        <span class="k">if</span> <span class="n">phi_height</span> <span class="o">&lt;</span> <span class="n">left_region_average_maxima_height</span><span class="p">:</span>
            <span class="n">highest_height</span> <span class="o">=</span> <span class="n">left_region_average_maxima_height</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">highest_height</span> <span class="o">=</span><span class="n">phi_height</span>
        <span class="n">E0</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">J2eV</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi0_dic</span><span class="p">[</span><span class="s1">&#39;E0&#39;</span><span class="p">])</span>
        <span class="n">phi_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">E0</span> <span class="o">-</span> <span class="n">highest_height</span><span class="p">)</span>
        <span class="n">E4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi_height</span> <span class="o">-</span>  <span class="n">left_region_average_maxima_height</span><span class="p">)</span>
        <span class="n">E3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">left_region_average_maxima_height</span> <span class="o">-</span> <span class="n">left_region_average_minima_height</span><span class="p">)</span>
        <span class="n">Delta_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Delta_height</span> <span class="o">-</span> <span class="n">left_region_average_minima_height</span> <span class="p">)</span>
        <span class="c1">#sigma_width = np.abs(Delta_pos - sigma_pos)</span>
        <span class="n">sigma_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">interface_initial_pos</span> <span class="o">-</span> <span class="n">sigma_pos</span><span class="p">)</span>
        <span class="n">sigma_height</span>  <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">ind_interface_final_pos</span><span class="p">])</span>
        <span class="n">E1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">highest_height</span> <span class="o">-</span>  <span class="n">right_region_average_maxima_height</span><span class="p">)</span>
        <span class="n">E2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">right_region_average_maxima_height</span> <span class="o">-</span> <span class="n">right_region_average_minima_height</span><span class="p">)</span>
        <span class="n">E0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">new_v_region</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_z_region</span><span class="p">,</span><span class="n">new_v_region</span><span class="p">,</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>

        <span class="c1">#E3</span>
        <span class="k">if</span> <span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">first_two_maxima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">left_side_left</span> <span class="o">=</span> <span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">left_side_right</span> <span class="o">=</span> <span class="n">first_two_maxima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left_side_left</span> <span class="o">=</span> <span class="n">first_two_maxima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">left_side_right</span> <span class="o">=</span> <span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">first_two_maxima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">right_side_left</span> <span class="o">=</span> <span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">right_side_right</span> <span class="o">=</span> <span class="n">first_two_maxima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">right_side_left</span> <span class="o">=</span> <span class="n">first_two_maxima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">right_side_right</span> <span class="o">=</span> <span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d_space_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">d_space_right</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d_space_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">d_space_left</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">left_region_average_minima_height</span><span class="p">,</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">Delta_pos</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyles</span> <span class="o">=</span> <span class="s1">&#39;dashdot&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># E4</span>
        <span class="c1">#ax.hlines(left_region_average_maxima_height, left_side_left-0.3,  left_side_right+0.3 , linestyles=&#39;dashdot&#39;,color=&#39;g&#39;,lw=1,alpha=0.7,zorder=0)</span>
        <span class="c1"># phi</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">highest_height</span><span class="p">,</span> <span class="n">left_side_left</span><span class="p">,</span> <span class="n">right_side_right</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashdot&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phi_height</span> <span class="o">&lt;</span> <span class="n">highest_height</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">phi_height</span><span class="p">,</span> <span class="n">left_side_left</span><span class="p">,</span> <span class="n">right_side_right</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashdot&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                      <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#E1</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">right_region_average_maxima_height</span><span class="p">,</span> <span class="n">right_side_left</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">right_side_right</span><span class="o">+</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashdot&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#E2</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">right_region_average_minima_height</span><span class="p">,</span> <span class="n">right_side_left</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">right_side_right</span><span class="o">+</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashdot&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#intertface</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#regions separation</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">interface_initial_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span> <span class="n">interface_final_pos</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#delta</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">Delta_pos</span><span class="p">,</span> <span class="n">sigma_height</span><span class="p">,</span> <span class="n">Delta_height</span><span class="p">,</span><span class="n">linestyles</span><span class="o">=</span>  <span class="s1">&#39;dashdot&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">E0</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;aqua&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">Delta_pos</span><span class="p">,</span> <span class="n">left_region_average_minima_height</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">Delta_pos</span><span class="p">,</span> <span class="n">Delta_height</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&gt;&quot;</span><span class="p">,</span>
                                    <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3&quot;</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">Delta_pos</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="p">((</span><span class="n">left_region_average_minima_height</span><span class="o">+</span><span class="n">Delta_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">Delta_pos</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,((</span><span class="n">left_region_average_minima_height</span><span class="o">+</span><span class="n">Delta_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">left_region_average_minima_height</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">left_region_average_maxima_height</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&gt;&quot;</span><span class="p">,</span>
                                    <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3&quot;</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_3$&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="p">(</span><span class="n">left_region_average_minima_height</span><span class="o">+</span><span class="n">left_region_average_maxima_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="p">(</span><span class="n">left_region_average_minima_height</span><span class="o">+</span><span class="n">left_region_average_maxima_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="n">left_region_average_maxima_height</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">phi_height</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&gt;&quot;</span><span class="p">,</span>
                                    <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3&quot;</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_4$&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">left_region_average_maxima_height</span><span class="o">+</span><span class="n">phi_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">left_region_average_maxima_height</span><span class="o">+</span><span class="n">phi_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">phi_pos</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">highest_height</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">phi_pos</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">E0</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&gt;&quot;</span><span class="p">,</span>
                                    <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3&quot;</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Phi$&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">phi_pos</span><span class="o">+</span><span class="mf">0.18</span><span class="p">,</span> <span class="p">(</span><span class="n">E0</span><span class="o">+</span><span class="n">highest_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">phi_pos</span><span class="o">+</span><span class="mf">0.18</span><span class="p">,(</span><span class="n">E0</span><span class="o">+</span><span class="n">highest_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">right_region_average_minima_height</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">right_region_average_maxima_height</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&gt;&quot;</span><span class="p">,</span>
                                    <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3&quot;</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_2$&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.07</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">right_region_average_minima_height</span><span class="o">+</span><span class="n">right_region_average_maxima_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.07</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">right_region_average_minima_height</span><span class="o">+</span><span class="n">right_region_average_maxima_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">right_region_average_maxima_height</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">highest_height</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&gt;&quot;</span><span class="p">,</span>
                                    <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3&quot;</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E_1$&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="p">(</span><span class="n">highest_height</span><span class="o">+</span><span class="n">right_region_average_maxima_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span> <span class="p">(</span><span class="n">highest_height</span><span class="o">+</span><span class="n">right_region_average_maxima_height</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">interface_initial_pos</span><span class="p">,</span> <span class="n">sigma_height</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">sigma_pos</span><span class="p">,</span> <span class="n">sigma_height</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&gt;&quot;</span><span class="p">,</span>
                                    <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3&quot;</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma$&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">((</span><span class="n">sigma_pos</span><span class="o">+</span><span class="n">interface_initial_pos</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma_height</span><span class="o">-</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">((</span><span class="n">sigma_pos</span><span class="o">+</span><span class="n">interface_initial_pos</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma_height</span><span class="o">-</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>

                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">right_region_average_minima_height</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">right_region_average_minima_height</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&gt;&quot;</span><span class="p">,</span>
                                    <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3&quot;</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ d_{(001)} $&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">((</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>  <span class="n">right_region_average_minima_height</span><span class="o">-</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">((</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">first_two_minima_from_right</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>  <span class="n">right_region_average_minima_height</span><span class="o">-</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>

                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">left_region_average_minima_height</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">left_region_average_minima_height</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;&lt;-&gt;&quot;</span><span class="p">,</span>
                                    <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;arc3&quot;</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                    <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ d_{(001)} $&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">((</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>  <span class="n">left_region_average_minima_height</span><span class="o">-</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">((</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">first_two_minima_from_left</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>  <span class="n">left_region_average_minima_height</span><span class="o">-</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>

                    <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">new_z_interface</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightslategray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">new_z_interface</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_z_interface</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">new_z_interface</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">z_right_region</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;z axis &#39;</span> <span class="o">+</span>  <span class="sa">r</span><span class="s1">&#39;$[\AA]$&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">new_z_region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">new_z_region</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-</span><span class="mf">0.6</span><span class="p">,</span><span class="n">E0</span><span class="o">+</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Local potential Energy, eV&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.133</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.934</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.164</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.961</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.085</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path_to_save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;Interface model new&#39;</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="s1">&#39;Interface model new&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)))</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span><span class="p">,</span>
                        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">dic_to_return</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;phi&#39;</span><span class="p">:</span><span class="n">phi_value</span><span class="p">,</span> <span class="s1">&#39;E1&#39;</span><span class="p">:</span><span class="n">E1</span><span class="p">,</span> <span class="s1">&#39;E2&#39;</span><span class="p">:</span><span class="n">E2</span><span class="p">,</span><span class="s1">&#39;E3&#39;</span><span class="p">:</span><span class="n">E3</span><span class="p">,</span><span class="s1">&#39;E4&#39;</span><span class="p">:</span><span class="n">E4</span><span class="p">,</span><span class="s1">&#39;Delta&#39;</span><span class="p">:</span> <span class="n">Delta_value</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span><span class="n">sigma_width</span><span class="p">,</span>  <span class="s1">&#39;d(001)_left&#39;</span><span class="p">:</span><span class="n">d_space_left</span><span class="p">,</span><span class="s1">&#39;d(001)_right&#39;</span><span class="p">:</span><span class="n">d_space_right</span><span class="p">,</span><span class="s1">&#39;interface_position&#39;</span><span class="p">:</span><span class="n">interface_pos</span><span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phi = </span><span class="si">{:.4g}</span><span class="s1"> ev&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phi_value</span><span class="p">)</span> <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;E1 = </span><span class="si">{:.4g}</span><span class="s1"> ev&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;E2 = </span><span class="si">{:.4g}</span><span class="s1"> ev&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E2</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;E3 = </span><span class="si">{:.4g}</span><span class="s1"> ev&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E3</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;E4 = </span><span class="si">{:.4g}</span><span class="s1"> ev&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E4</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Delta = </span><span class="si">{:.4g}</span><span class="s1"> ev&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Delta_value</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sigma = </span><span class="si">{:.3g}</span><span class="s1"> Ang&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma_width</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;d(001) left = </span><span class="si">{:.3g}</span><span class="s1"> Ang&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d_space_left</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;d(001) right = </span><span class="si">{:.3g}</span><span class="s1"> Ang&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d_space_right</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;interface position = </span><span class="si">{:.4g}</span><span class="s1"> Ang&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interface_pos</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dic_to_return</span></div>

<div class="viewcode-block" id="Stage_2.update_ref_point"><a class="viewcode-back" href="../Stage_2.html#Stage_2.Stage_2.update_ref_point">[docs]</a>    <span class="k">def</span> <span class="nf">update_ref_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ref_point</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ref_point : float</span>
<span class="sd">            The new reference point you wish to update for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Just update class object property.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ref_point</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">ref_point</span><span class="p">)</span>
        <span class="n">ref_point</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">m2A</span><span class="p">(</span><span class="n">ref_point</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_point</span> <span class="o">=</span> <span class="n">ref_point</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, MCT&amp;YairR&amp;NadavS

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>